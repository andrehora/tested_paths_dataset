<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>email.feedparser.FeedParser._parsegen</title>
    <meta http-equiv="X-UA-Compatible" content="IE=emulateIE7" />
<!--    <link rel="icon" sizes="32x32" href="favicon_32.png">-->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>&#128270;</text></svg>">
    <link rel="stylesheet" href="highlight.css" type="text/css">
</head>
<body class="pyfile">
<div id="source">
    <div class="highlight">
        <div id="header">
            <div class="content">
                <h1>Method: email.feedparser.FeedParser._parsegen</h1>
                <span>Calls: 1524, </span>
                <span>Exceptions: 1388, </span>
                <span>Paths: 61</span>
                <br><a href="index.html">Back</a>
            </div>
        </div>
            <p><b>Path 1</b>: 593 calls (0.39)</p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (593) </p>
            <button class="run" title="lines run...">18 run</button>
            <button class="not_run" title="lines not run...">162 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full not_run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full not_run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full not_run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full not_run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full not_run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full not_run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full not_run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full not_run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full not_run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full not_run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full not_run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 2</b>: 215 calls (0.14)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (20215) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (215) </p>
            <button class="run" title="lines run...">20 run</button>
            <button class="not_run" title="lines not run...">160 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full not_run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full not_run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full not_run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full not_run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full not_run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full not_run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full not_run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full not_run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full not_run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full not_run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full not_run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 3</b>: 111 calls (0.07)</p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (111) </p>
            <button class="run" title="lines run...">14 run</button>
            <button class="not_run" title="lines not run...">166 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full not_run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full not_run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full not_run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full not_run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full not_run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full not_run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full not_run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full not_run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full not_run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full not_run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full not_run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full not_run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 4</b>: 102 calls (0.07)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (102) </p>
                <p><button class="output"><span>&#8617; return</span></button> None (102) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (102) </p>
            <button class="run" title="lines run...">73 run</button>
            <button class="not_run" title="lines not run...">107 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 5</b>: 51 calls (0.03)</p>
                <p><button class="output"><span>&#8617; return</span></button> None (51) </p>
            <button class="run" title="lines run...">14 run</button>
            <button class="not_run" title="lines not run...">166 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full not_run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full not_run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full not_run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full not_run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full not_run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full not_run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full not_run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full not_run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full not_run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full not_run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full not_run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full not_run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full not_run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 6</b>: 48 calls (0.03)</p>
                <p><button class="output"><span>&#8617; return</span></button> None (48) </p>
            <button class="run" title="lines run...">15 run</button>
            <button class="not_run" title="lines not run...">165 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full not_run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full not_run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full not_run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full not_run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full not_run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full not_run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full not_run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full not_run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full not_run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full not_run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full not_run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full not_run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 7</b>: 46 calls (0.03)</p>
                <p><button class="output"><span>&#8617; return</span></button> None (46) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (46) </p>
            <button class="run" title="lines run...">72 run</button>
            <button class="not_run" title="lines not run...">108 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 8</b>: 36 calls (0.02)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (36) </p>
                <p><button class="output"><span>&#8617; return</span></button> None (36) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (36) </p>
            <button class="run" title="lines run...">80 run</button>
            <button class="not_run" title="lines not run...">100 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 9</b>: 35 calls (0.02)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (35) </p>
                <p><button class="output"><span>&#8617; return</span></button> None (35) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (35) </p>
            <button class="run" title="lines run...">80 run</button>
            <button class="not_run" title="lines not run...">100 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 10</b>: 33 calls (0.02)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (20066) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (33) </p>
            <button class="run" title="lines run...">16 run</button>
            <button class="not_run" title="lines not run...">164 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full not_run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full not_run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full not_run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full not_run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full not_run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full not_run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full not_run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full not_run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full not_run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full not_run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full not_run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full not_run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 11</b>: 32 calls (0.02)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (32) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (32) </p>
            <button class="run" title="lines run...">19 run</button>
            <button class="not_run" title="lines not run...">161 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full not_run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full not_run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full not_run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full not_run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full not_run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full not_run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full not_run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full not_run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full not_run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full not_run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full not_run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 12</b>: 30 calls (0.02)</p>
                <p><button class="output"><span>&#8617; return</span></button> None (30) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (30) </p>
            <button class="run" title="lines run...">79 run</button>
            <button class="not_run" title="lines not run...">101 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 13</b>: 23 calls (0.02)</p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (23) </p>
            <button class="run" title="lines run...">11 run</button>
            <button class="not_run" title="lines not run...">169 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full not_run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full not_run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full not_run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full not_run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full not_run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full not_run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full not_run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full not_run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full not_run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full not_run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full not_run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full not_run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full not_run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 14</b>: 22 calls (0.01)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (22) </p>
                <p><button class="output"><span>&#8617; return</span></button> None (22) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (22) </p>
            <button class="run" title="lines run...">81 run</button>
            <button class="not_run" title="lines not run...">99 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 15</b>: 20 calls (0.01)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (20) </p>
                <p><button class="output"><span>&#8617; return</span></button> None (20) </p>
            <button class="run" title="lines run...">18 run</button>
            <button class="not_run" title="lines not run...">162 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full not_run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full not_run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full not_run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full not_run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full not_run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full not_run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full not_run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full not_run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full not_run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full not_run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full not_run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full not_run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 16</b>: 19 calls (0.01)</p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (19) </p>
            <button class="run" title="lines run...">17 run</button>
            <button class="not_run" title="lines not run...">163 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full not_run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full not_run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full not_run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full not_run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full not_run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full not_run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full not_run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full not_run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full not_run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full not_run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full not_run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full not_run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 17</b>: 12 calls (0.01)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (12) </p>
                <p><button class="output"><span>&#8617; return</span></button> None (12) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (12) </p>
            <button class="run" title="lines run...">81 run</button>
            <button class="not_run" title="lines not run...">99 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 18</b>: 9 calls (0.01)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (9) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (9) </p>
            <button class="run" title="lines run...">23 run</button>
            <button class="not_run" title="lines not run...">157 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full not_run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full not_run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full not_run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full not_run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full not_run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full not_run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full not_run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full not_run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full not_run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full not_run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full not_run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 19</b>: 8 calls (0.01)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (8) </p>
                <p><button class="output"><span>&#8617; return</span></button> None (8) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (8) </p>
            <button class="run" title="lines run...">25 run</button>
            <button class="not_run" title="lines not run...">155 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full not_run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full not_run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full not_run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full not_run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full not_run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full not_run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full not_run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full not_run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full not_run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full not_run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 20</b>: 7 calls (0.0)</p>
                <p><button class="warning"><span>&#9888; exception</span></button> TestException (6) FirstHeaderLineIsContinuationDefect (1) </p>
            <button class="run" title="lines run...">9 run</button>
            <button class="not_run" title="lines not run...">171 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full not_run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full not_run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full not_run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full not_run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full not_run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full not_run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full not_run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full not_run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full not_run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full not_run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full not_run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full not_run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full not_run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full not_run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full not_run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 21</b>: 4 calls (0.0)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (4) </p>
                <p><button class="output"><span>&#8617; return</span></button> None (4) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (4) </p>
            <button class="run" title="lines run...">77 run</button>
            <button class="not_run" title="lines not run...">103 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 22</b>: 4 calls (0.0)</p>
                <p><button class="output"><span>&#8617; return</span></button> None (4) </p>
            <button class="run" title="lines run...">28 run</button>
            <button class="not_run" title="lines not run...">152 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full not_run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full not_run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full not_run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full not_run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full not_run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full not_run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full not_run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full not_run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full not_run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full not_run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full not_run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full not_run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full not_run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 23</b>: 4 calls (0.0)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (8) </p>
                <p><button class="output"><span>&#8617; return</span></button> None (4) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (4) </p>
            <button class="run" title="lines run...">84 run</button>
            <button class="not_run" title="lines not run...">96 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 24</b>: 4 calls (0.0)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (4) </p>
                <p><button class="output"><span>&#8617; return</span></button> None (4) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (4) </p>
            <button class="run" title="lines run...">44 run</button>
            <button class="not_run" title="lines not run...">136 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 25</b>: 4 calls (0.0)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (4) </p>
                <p><button class="output"><span>&#8617; return</span></button> None (4) </p>
            <button class="run" title="lines run...">21 run</button>
            <button class="not_run" title="lines not run...">159 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full not_run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full not_run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full not_run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full not_run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full not_run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full not_run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full not_run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full not_run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full not_run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full not_run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full not_run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full not_run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full not_run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full not_run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 26</b>: 3 calls (0.0)</p>
                <p><button class="output"><span>&#8617; return</span></button> None (3) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (3) </p>
            <button class="run" title="lines run...">44 run</button>
            <button class="not_run" title="lines not run...">136 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 27</b>: 3 calls (0.0)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (3) </p>
                <p><button class="output"><span>&#8617; return</span></button> None (3) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (3) </p>
            <button class="run" title="lines run...">75 run</button>
            <button class="not_run" title="lines not run...">105 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 28</b>: 3 calls (0.0)</p>
                <p><button class="output"><span>&#8617; return</span></button> None (3) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (3) </p>
            <button class="run" title="lines run...">38 run</button>
            <button class="not_run" title="lines not run...">142 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 29</b>: 3 calls (0.0)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (3) </p>
                <p><button class="output"><span>&#8617; return</span></button> None (3) </p>
            <button class="run" title="lines run...">30 run</button>
            <button class="not_run" title="lines not run...">150 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full not_run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full not_run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full not_run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full not_run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full not_run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full not_run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full not_run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full not_run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full not_run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full not_run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full not_run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full not_run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full not_run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 30</b>: 2 calls (0.0)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (2) </p>
                <p><button class="output"><span>&#8617; return</span></button> None (2) </p>
            <button class="run" title="lines run...">65 run</button>
            <button class="not_run" title="lines not run...">115 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 31</b>: 2 calls (0.0)</p>
                <p><button class="warning"><span>&#9888; exception</span></button> NoBoundaryInMultipartDefect (2) </p>
            <button class="run" title="lines run...">17 run</button>
            <button class="not_run" title="lines not run...">163 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full not_run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full not_run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full not_run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full not_run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full not_run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full not_run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full not_run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full not_run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full not_run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full not_run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 32</b>: 2 calls (0.0)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (2) </p>
                <p><button class="output"><span>&#8617; return</span></button> None (2) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (2) </p>
            <button class="run" title="lines run...">74 run</button>
            <button class="not_run" title="lines not run...">106 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 33</b>: 2 calls (0.0)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (40002) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (2) </p>
            <button class="run" title="lines run...">20 run</button>
            <button class="not_run" title="lines not run...">160 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full not_run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full not_run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full not_run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full not_run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full not_run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full not_run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full not_run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full not_run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full not_run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full not_run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full not_run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 34</b>: 2 calls (0.0)</p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (2) </p>
            <button class="run" title="lines run...">16 run</button>
            <button class="not_run" title="lines not run...">164 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full not_run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full not_run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full not_run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full not_run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full not_run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full not_run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full not_run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full not_run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full not_run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full not_run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full not_run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 35</b>: 2 calls (0.0)</p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (2) </p>
            <button class="run" title="lines run...">20 run</button>
            <button class="not_run" title="lines not run...">160 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full not_run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full not_run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full not_run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full not_run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full not_run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full not_run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full not_run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full not_run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full not_run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full not_run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full not_run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full not_run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 36</b>: 2 calls (0.0)</p>
                <p><button class="warning"><span>&#9888; exception</span></button> StartBoundaryNotFoundDefect (2) </p>
            <button class="run" title="lines run...">53 run</button>
            <button class="not_run" title="lines not run...">127 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 37</b>: 2 calls (0.0)</p>
                <p><button class="warning"><span>&#9888; exception</span></button> StartBoundaryNotFoundDefect (2) </p>
            <button class="run" title="lines run...">37 run</button>
            <button class="not_run" title="lines not run...">143 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 38</b>: 1 calls (0.0)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (1) </p>
                <p><button class="output"><span>&#8617; return</span></button> None (1) </p>
            <button class="run" title="lines run...">62 run</button>
            <button class="not_run" title="lines not run...">118 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 39</b>: 1 calls (0.0)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (1) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> CloseBoundaryNotFoundDefect (1) </p>
            <button class="run" title="lines run...">64 run</button>
            <button class="not_run" title="lines not run...">116 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 40</b>: 1 calls (0.0)</p>
                <p><button class="warning"><span>&#9888; exception</span></button> MissingHeaderBodySeparatorDefect (1) </p>
            <button class="run" title="lines run...">9 run</button>
            <button class="not_run" title="lines not run...">171 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full not_run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full not_run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full not_run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full not_run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full not_run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full not_run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full not_run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full not_run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full not_run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full not_run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full not_run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full not_run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full not_run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full not_run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full not_run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 41</b>: 1 calls (0.0)</p>
                <p><button class="warning"><span>&#9888; exception</span></button> StartBoundaryNotFoundDefect (1) </p>
            <button class="run" title="lines run...">56 run</button>
            <button class="not_run" title="lines not run...">124 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 42</b>: 1 calls (0.0)</p>
                <p><button class="warning"><span>&#9888; exception</span></button> StartBoundaryNotFoundDefect (1) </p>
            <button class="run" title="lines run...">13 run</button>
            <button class="not_run" title="lines not run...">167 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full not_run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full not_run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full not_run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full not_run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full not_run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full not_run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full not_run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full not_run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full not_run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full not_run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full not_run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full not_run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 43</b>: 1 calls (0.0)</p>
                <p><button class="warning"><span>&#9888; exception</span></button> StartBoundaryNotFoundDefect (1) </p>
            <button class="run" title="lines run...">38 run</button>
            <button class="not_run" title="lines not run...">142 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 44</b>: 1 calls (0.0)</p>
                <p><button class="warning"><span>&#9888; exception</span></button> InvalidMultipartContentTransferEncodingDefect (1) </p>
            <button class="run" title="lines run...">19 run</button>
            <button class="not_run" title="lines not run...">161 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full not_run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full not_run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full not_run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full not_run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full not_run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full not_run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full not_run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full not_run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 45</b>: 1 calls (0.0)</p>
                <p><button class="warning"><span>&#9888; exception</span></button> StartBoundaryNotFoundDefect (1) </p>
            <button class="run" title="lines run...">46 run</button>
            <button class="not_run" title="lines not run...">134 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 46</b>: 1 calls (0.0)</p>
                <p><button class="warning"><span>&#9888; exception</span></button> StartBoundaryNotFoundDefect (1) </p>
            <button class="run" title="lines run...">33 run</button>
            <button class="not_run" title="lines not run...">147 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 47</b>: 1 calls (0.0)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (21) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (1) </p>
            <button class="run" title="lines run...">22 run</button>
            <button class="not_run" title="lines not run...">158 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full not_run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full not_run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full not_run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full not_run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full not_run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full not_run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full not_run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full not_run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full not_run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full not_run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full not_run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 48</b>: 1 calls (0.0)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (1) </p>
                <p><button class="output"><span>&#8617; return</span></button> None (1) </p>
            <button class="run" title="lines run...">31 run</button>
            <button class="not_run" title="lines not run...">149 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full not_run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full not_run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full not_run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full not_run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full not_run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full not_run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full not_run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full not_run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full not_run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full not_run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full not_run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full not_run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full not_run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 49</b>: 1 calls (0.0)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (1) </p>
                <p><button class="output"><span>&#8617; return</span></button> None (1) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (1) </p>
            <button class="run" title="lines run...">40 run</button>
            <button class="not_run" title="lines not run...">140 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full not_run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 50</b>: 1 calls (0.0)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (1) </p>
                <p><button class="output"><span>&#8617; return</span></button> None (1) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (1) </p>
            <button class="run" title="lines run...">70 run</button>
            <button class="not_run" title="lines not run...">110 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 51</b>: 1 calls (0.0)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (1) </p>
                <p><button class="output"><span>&#8617; return</span></button> None (1) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (1) </p>
            <button class="run" title="lines run...">76 run</button>
            <button class="not_run" title="lines not run...">104 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 52</b>: 1 calls (0.0)</p>
                <p><button class="output"><span>&#8617; return</span></button> None (1) </p>
            <button class="run" title="lines run...">65 run</button>
            <button class="not_run" title="lines not run...">115 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 53</b>: 1 calls (0.0)</p>
                <p><button class="output"><span>&#8617; return</span></button> None (1) </p>
            <button class="run" title="lines run...">62 run</button>
            <button class="not_run" title="lines not run...">118 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 54</b>: 1 calls (0.0)</p>
                <p><button class="output"><span>&#8617; return</span></button> None (1) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (1) </p>
            <button class="run" title="lines run...">75 run</button>
            <button class="not_run" title="lines not run...">105 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 55</b>: 1 calls (0.0)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (1) </p>
                <p><button class="output"><span>&#8617; return</span></button> None (1) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (1) </p>
            <button class="run" title="lines run...">83 run</button>
            <button class="not_run" title="lines not run...">97 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 56</b>: 1 calls (0.0)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (1) </p>
                <p><button class="output"><span>&#8617; return</span></button> None (1) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (1) </p>
            <button class="run" title="lines run...">84 run</button>
            <button class="not_run" title="lines not run...">96 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 57</b>: 1 calls (0.0)</p>
                <p><button class="output"><span>&#8617; return</span></button> None (1) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (1) </p>
            <button class="run" title="lines run...">42 run</button>
            <button class="not_run" title="lines not run...">138 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 58</b>: 1 calls (0.0)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (1) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (1) </p>
            <button class="run" title="lines run...">22 run</button>
            <button class="not_run" title="lines not run...">158 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full not_run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full not_run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full not_run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full not_run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full not_run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full not_run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full not_run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full not_run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full not_run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full not_run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full not_run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full not_run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 59</b>: 1 calls (0.0)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (1) </p>
                <p><button class="output"><span>&#8617; return</span></button> None (1) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (1) </p>
            <button class="run" title="lines run...">40 run</button>
            <button class="not_run" title="lines not run...">140 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full not_run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 60</b>: 1 calls (0.0)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (1) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (1) </p>
            <button class="run" title="lines run...">22 run</button>
            <button class="not_run" title="lines not run...">158 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full not_run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full not_run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full not_run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full not_run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full not_run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full not_run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full not_run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full not_run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full not_run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full not_run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full not_run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full not_run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full not_run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full not_run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
            <p><b>Path 61</b>: 1 calls (0.0)</p>
                <p><button class="output"><span>&#8647; yield</span></button> object (1) </p>
                <p><button class="output"><span>&#8617; return</span></button> None (1) </p>
                <p><button class="warning"><span>&#9888; exception</span></button> StopIteration (1) </p>
            <button class="run" title="lines run...">28 run</button>
            <button class="not_run" title="lines not run...">152 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_parsegen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span>        <span class="c1"># Create a new message and start by parsing headers.</span></span>
<span class="num"><a href="#3">3</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_message</span><span class="p">()</span></span>
<span class="num"><a href="#4">4</a></span><span class="full run">        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#5">5</a></span><span>        <span class="c1"># Collect the headers, searching for a line that doesn&#39;t match the RFC</span></span>
<span class="num"><a href="#6">6</a></span><span>        <span class="c1"># 2822 header or continuation pattern (including an empty line).</span></span>
<span class="num"><a href="#7">7</a></span><span class="full run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#8">8</a></span><span class="full run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#9">9</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#10">10</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#11">11</a></span><span class="full run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#12">12</a></span><span>                <span class="c1"># If we saw the RFC defined header/body separator</span></span>
<span class="num"><a href="#13">13</a></span><span>                <span class="c1"># (i.e. newline), just throw it away. Otherwise the line is</span></span>
<span class="num"><a href="#14">14</a></span><span>                <span class="c1"># part of the body so push it back.</span></span>
<span class="num"><a href="#15">15</a></span><span class="full run">                <span class="k">if</span> <span class="ow">not</span> <span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span></span>
<span class="num"><a href="#16">16</a></span><span class="full run">                    <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingHeaderBodySeparatorDefect</span><span class="p">()</span></span>
<span class="num"><a href="#17">17</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#18">18</a></span><span class="full run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#19">19</a></span><span class="full run">                <span class="k">break</span></span>
<span class="num"><a href="#20">20</a></span><span class="full run">            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># Done with the headers, so parse them and figure out what we&#39;re</span></span>
<span class="num"><a href="#22">22</a></span><span>        <span class="c1"># supposed to see in the body of the message.</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span>        <span class="c1"># Headers-only parsing is a backwards compatibility hack, which was</span></span>
<span class="num"><a href="#25">25</a></span><span>        <span class="c1"># necessary in the older parser, which could raise errors.  All</span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># remaining lines in the input are thrown into the message body.</span></span>
<span class="num"><a href="#27">27</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headersonly</span><span class="p">:</span></span>
<span class="num"><a href="#28">28</a></span><span class="full not_run">            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#29">29</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#30">30</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#31">31</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#32">32</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#33">33</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#34">34</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#38">38</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#39">39</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message/delivery-status&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#40">40</a></span><span>            <span class="c1"># message/delivery-status contains blocks of headers separated by</span></span>
<span class="num"><a href="#41">41</a></span><span>            <span class="c1"># a blank line.  We&#39;ll represent each header block as a separate</span></span>
<span class="num"><a href="#42">42</a></span><span>            <span class="c1"># nested message object, but the processing is a bit different</span></span>
<span class="num"><a href="#43">43</a></span><span>            <span class="c1"># than standard message/* types because there is no body for the</span></span>
<span class="num"><a href="#44">44</a></span><span>            <span class="c1"># nested messages.  A blank line separates the subparts.</span></span>
<span class="num"><a href="#45">45</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">NLCRE</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#49">49</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#50">50</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#52">52</a></span><span class="full not_run">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#53">53</a></span><span>                <span class="c1"># We need to pop the EOF matcher in order to tell if we&#39;re at</span></span>
<span class="num"><a href="#54">54</a></span><span>                <span class="c1"># the end of the current file, not the end of the last block</span></span>
<span class="num"><a href="#55">55</a></span><span>                <span class="c1"># of message headers.</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#57">57</a></span><span>                <span class="c1"># The input stream must be sitting at the newline or at the</span></span>
<span class="num"><a href="#58">58</a></span><span>                <span class="c1"># EOF.  We want to see if we&#39;re at the end of this subpart, so</span></span>
<span class="num"><a href="#59">59</a></span><span>                <span class="c1"># first consume the blank line, then test the next line to see</span></span>
<span class="num"><a href="#60">60</a></span><span>                <span class="c1"># if we&#39;re at this subpart&#39;s EOF.</span></span>
<span class="num"><a href="#61">61</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#62">62</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#63">63</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#64">64</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#66">66</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#67">67</a></span><span class="full not_run">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#75">75</a></span><span>                <span class="c1"># Not at EOF so this is a line we&#39;re going to need.</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span>            <span class="c1"># The message claims to be a message/* type, then what follows is</span></span>
<span class="num"><a href="#80">80</a></span><span>            <span class="c1"># another RFC 2822 message.</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#85">85</a></span><span class="full not_run">                <span class="k">break</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#88">88</a></span><span class="full run">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span class="full run">            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span></span>
<span class="num"><a href="#90">90</a></span><span class="full run">            <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#91">91</a></span><span>                <span class="c1"># The message /claims/ to be a multipart but it has not</span></span>
<span class="num"><a href="#92">92</a></span><span>                <span class="c1"># defined a boundary.  That&#39;s a problem which we&#39;ll handle by</span></span>
<span class="num"><a href="#93">93</a></span><span>                <span class="c1"># reading everything until the EOF and marking the message as</span></span>
<span class="num"><a href="#94">94</a></span><span>                <span class="c1"># defective.</span></span>
<span class="num"><a href="#95">95</a></span><span class="full run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NoBoundaryInMultipartDefect</span><span class="p">()</span></span>
<span class="num"><a href="#96">96</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#97">97</a></span><span class="full run">                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#98">98</a></span><span class="full run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#99">99</a></span><span class="full run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#100">100</a></span><span class="full run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#101">101</a></span><span class="full run">                        <span class="k">continue</span></span>
<span class="num"><a href="#102">102</a></span><span class="full run">                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#103">103</a></span><span class="full run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
<span class="num"><a href="#104">104</a></span><span class="full run">                <span class="k">return</span></span>
<span class="num"><a href="#105">105</a></span><span>            <span class="c1"># Make sure a valid content type was specified per RFC 2045:6.4.</span></span>
<span class="num"><a href="#106">106</a></span><span class="full not_run">            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></span>
<span class="num"><a href="#107">107</a></span><span class="full not_run">                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;7bit&#39;</span><span class="p">,</span> <span class="s1">&#39;8bit&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">)):</span></span>
<span class="num"><a href="#108">108</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidMultipartContentTransferEncodingDefect</span><span class="p">()</span></span>
<span class="num"><a href="#109">109</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#110">110</a></span><span>            <span class="c1"># Create a line match predicate which matches the inter-part</span></span>
<span class="num"><a href="#111">111</a></span><span>            <span class="c1"># boundary as well as the end-of-multipart boundary.  Don&#39;t push</span></span>
<span class="num"><a href="#112">112</a></span><span>            <span class="c1"># this onto the input stream until we&#39;ve scanned past the</span></span>
<span class="num"><a href="#113">113</a></span><span>            <span class="c1"># preamble.</span></span>
<span class="num"><a href="#114">114</a></span><span class="full not_run">            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span></span>
<span class="num"><a href="#115">115</a></span><span class="full not_run">            <span class="n">boundaryre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span></span>
<span class="num"><a href="#116">116</a></span><span class="full not_run">                <span class="s1">&#39;(?P&lt;sep&gt;&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span></span>
<span class="num"><a href="#117">117</a></span><span class="full not_run">                <span class="sa">r</span><span class="s1">&#39;)(?P&lt;end&gt;--)?(?P&lt;ws&gt;[ \t]*)(?P&lt;linesep&gt;\r\n|\r|\n)?$&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#118">118</a></span><span class="full not_run">            <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#119">119</a></span><span class="full not_run">            <span class="n">preamble</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#120">120</a></span><span class="full not_run">            <span class="n">linesep</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#121">121</a></span><span class="full not_run">            <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#122">122</a></span><span class="full not_run">            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#123">123</a></span><span class="full not_run">                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#124">124</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#125">125</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#126">126</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#127">127</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#128">128</a></span><span class="full not_run">                    <span class="k">break</span></span>
<span class="num"><a href="#129">129</a></span><span class="full not_run">                <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#130">130</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#131">131</a></span><span>                    <span class="c1"># If we&#39;re looking at the end boundary, we&#39;re done with</span></span>
<span class="num"><a href="#132">132</a></span><span>                    <span class="c1"># this multipart.  If there was a newline at the end of</span></span>
<span class="num"><a href="#133">133</a></span><span>                    <span class="c1"># the closing boundary, then we need to initialize the</span></span>
<span class="num"><a href="#134">134</a></span><span>                    <span class="c1"># epilogue with the empty string (see below).</span></span>
<span class="num"><a href="#135">135</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span></span>
<span class="num"><a href="#136">136</a></span><span class="full not_run">                        <span class="n">close_boundary_seen</span> <span class="o">=</span> <span class="kc">True</span></span>
<span class="num"><a href="#137">137</a></span><span class="full not_run">                        <span class="n">linesep</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linesep&#39;</span><span class="p">)</span></span>
<span class="num"><a href="#138">138</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#139">139</a></span><span>                    <span class="c1"># We saw an inter-part boundary.  Were we in the preamble?</span></span>
<span class="num"><a href="#140">140</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#141">141</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span></span>
<span class="num"><a href="#142">142</a></span><span>                            <span class="c1"># According to RFC 2046, the last newline belongs</span></span>
<span class="num"><a href="#143">143</a></span><span>                            <span class="c1"># to the boundary.</span></span>
<span class="num"><a href="#144">144</a></span><span class="full not_run">                            <span class="n">lastline</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></span>
<span class="num"><a href="#145">145</a></span><span class="full not_run">                            <span class="n">eolmo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lastline</span><span class="p">)</span></span>
<span class="num"><a href="#146">146</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">eolmo</span><span class="p">:</span></span>
<span class="num"><a href="#147">147</a></span><span class="full not_run">                                <span class="n">preamble</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastline</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#148">148</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span></span>
<span class="num"><a href="#149">149</a></span><span class="full not_run">                        <span class="n">capturing_preamble</span> <span class="o">=</span> <span class="kc">False</span></span>
<span class="num"><a href="#150">150</a></span><span class="full not_run">                        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#151">151</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#152">152</a></span><span>                    <span class="c1"># We saw a boundary separating two parts.  Consume any</span></span>
<span class="num"><a href="#153">153</a></span><span>                    <span class="c1"># multiple boundary lines that may be following.  Our</span></span>
<span class="num"><a href="#154">154</a></span><span>                    <span class="c1"># interpretation of RFC 2046 BNF grammar does not produce</span></span>
<span class="num"><a href="#155">155</a></span><span>                    <span class="c1"># body parts within such double boundaries.</span></span>
<span class="num"><a href="#156">156</a></span><span class="full not_run">                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span></span>
<span class="num"><a href="#157">157</a></span><span class="full not_run">                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></span>
<span class="num"><a href="#158">158</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#159">159</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#160">160</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#161">161</a></span><span class="full not_run">                        <span class="n">mo</span> <span class="o">=</span> <span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#162">162</a></span><span class="full not_run">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#163">163</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">unreadline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#164">164</a></span><span class="full not_run">                            <span class="k">break</span></span>
<span class="num"><a href="#165">165</a></span><span>                    <span class="c1"># Recurse to parse this subpart; the input stream points</span></span>
<span class="num"><a href="#166">166</a></span><span>                    <span class="c1"># at the subpart&#39;s first line.</span></span>
<span class="num"><a href="#167">167</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">push_eof_matcher</span><span class="p">(</span><span class="n">boundaryre</span><span class="o">.</span><span class="n">match</span><span class="p">)</span></span>
<span class="num"><a href="#168">168</a></span><span class="full not_run">                    <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsegen</span><span class="p">():</span></span>
<span class="num"><a href="#169">169</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#170">170</a></span><span class="full not_run">                            <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#171">171</a></span><span class="full not_run">                            <span class="k">continue</span></span>
<span class="num"><a href="#172">172</a></span><span class="full not_run">                        <span class="k">break</span></span>
<span class="num"><a href="#173">173</a></span><span>                    <span class="c1"># Because of RFC 2046, the newline preceding the boundary</span></span>
<span class="num"><a href="#174">174</a></span><span>                    <span class="c1"># separator actually belongs to the boundary, not the</span></span>
<span class="num"><a href="#175">175</a></span><span>                    <span class="c1"># previous subpart&#39;s payload (or epilogue if the previous</span></span>
<span class="num"><a href="#176">176</a></span><span>                    <span class="c1"># part is a multipart).</span></span>
<span class="num"><a href="#177">177</a></span><span class="full not_run">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multipart&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#178">178</a></span><span class="full not_run">                        <span class="n">epilogue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span></span>
<span class="num"><a href="#179">179</a></span><span class="full not_run">                        <span class="k">if</span> <span class="n">epilogue</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#180">180</a></span><span class="full not_run">                            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#181">181</a></span><span class="full not_run">                        <span class="k">elif</span> <span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#182">182</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#183">183</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#184">184</a></span><span class="full not_run">                                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></span>
<span class="num"><a href="#185">185</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[:</span><span class="o">-</span><span class="n">end</span><span class="p">]</span></span>
<span class="num"><a href="#186">186</a></span><span>                    <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#187">187</a></span><span class="full not_run">                        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span></span>
<span class="num"><a href="#188">188</a></span><span class="full not_run">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></span>
<span class="num"><a href="#189">189</a></span><span class="full not_run">                            <span class="n">mo</span> <span class="o">=</span> <span class="n">NLCRE_eol</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></span>
<span class="num"><a href="#190">190</a></span><span class="full not_run">                            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span></span>
<span class="num"><a href="#191">191</a></span><span class="full not_run">                                <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))]</span></span>
<span class="num"><a href="#192">192</a></span><span class="full not_run">                                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">payload</span></span>
<span class="num"><a href="#193">193</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="o">.</span><span class="n">pop_eof_matcher</span><span class="p">()</span></span>
<span class="num"><a href="#194">194</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_pop_message</span><span class="p">()</span></span>
<span class="num"><a href="#195">195</a></span><span>                    <span class="c1"># Set the multipart up for newline cleansing, which will</span></span>
<span class="num"><a href="#196">196</a></span><span>                    <span class="c1"># happen if we&#39;re in a nested multipart.</span></span>
<span class="num"><a href="#197">197</a></span><span class="full not_run">                    <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span></span>
<span class="num"><a href="#198">198</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#199">199</a></span><span>                    <span class="c1"># I think we must be in the preamble</span></span>
<span class="num"><a href="#200">200</a></span><span class="full not_run">                    <span class="k">assert</span> <span class="n">capturing_preamble</span></span>
<span class="num"><a href="#201">201</a></span><span class="full not_run">                    <span class="n">preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#202">202</a></span><span>            <span class="c1"># We&#39;ve seen either the EOF or the end boundary.  If we&#39;re still</span></span>
<span class="num"><a href="#203">203</a></span><span>            <span class="c1"># capturing the preamble, we never saw the start boundary.  Note</span></span>
<span class="num"><a href="#204">204</a></span><span>            <span class="c1"># that as a defect and store the captured text as the payload.</span></span>
<span class="num"><a href="#205">205</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">capturing_preamble</span><span class="p">:</span></span>
<span class="num"><a href="#206">206</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">StartBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#207">207</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#208">208</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preamble</span><span class="p">))</span></span>
<span class="num"><a href="#209">209</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#210">210</a></span><span class="full not_run">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#211">211</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#212">212</a></span><span class="full not_run">                        <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#213">213</a></span><span class="full not_run">                        <span class="k">continue</span></span>
<span class="num"><a href="#214">214</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#215">215</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#216">216</a></span><span>            <span class="c1"># If we&#39;re not processing the preamble, then we might have seen</span></span>
<span class="num"><a href="#217">217</a></span><span>            <span class="c1"># EOF without seeing that end boundary...that is also a defect.</span></span>
<span class="num"><a href="#218">218</a></span><span class="full not_run">            <span class="k">if</span> <span class="ow">not</span> <span class="n">close_boundary_seen</span><span class="p">:</span></span>
<span class="num"><a href="#219">219</a></span><span class="full not_run">                <span class="n">defect</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">CloseBoundaryNotFoundDefect</span><span class="p">()</span></span>
<span class="num"><a href="#220">220</a></span><span class="full not_run">                <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">handle_defect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span></span>
<span class="num"><a href="#221">221</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#222">222</a></span><span>            <span class="c1"># Everything from here to the EOF is epilogue.  If the end boundary</span></span>
<span class="num"><a href="#223">223</a></span><span>            <span class="c1"># ended in a newline, we&#39;ll need to make sure the epilogue isn&#39;t</span></span>
<span class="num"><a href="#224">224</a></span><span>            <span class="c1"># None</span></span>
<span class="num"><a href="#225">225</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">linesep</span><span class="p">:</span></span>
<span class="num"><a href="#226">226</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></span>
<span class="num"><a href="#227">227</a></span><span>            <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#228">228</a></span><span class="full not_run">                <span class="n">epilogue</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#229">229</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#230">230</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#231">231</a></span><span class="full not_run">                    <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#232">232</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#233">233</a></span><span class="full not_run">                <span class="n">epilogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#234">234</a></span><span>            <span class="c1"># Any CRLF at the front of the epilogue is not technically part of</span></span>
<span class="num"><a href="#235">235</a></span><span>            <span class="c1"># the epilogue.  Also, watch out for an empty string epilogue,</span></span>
<span class="num"><a href="#236">236</a></span><span>            <span class="c1"># which means a single newline.</span></span>
<span class="num"><a href="#237">237</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span></span>
<span class="num"><a href="#238">238</a></span><span class="full not_run">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></span>
<span class="num"><a href="#239">239</a></span><span class="full not_run">                <span class="n">bolmo</span> <span class="o">=</span> <span class="n">NLCRE_bol</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span></span>
<span class="num"><a href="#240">240</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">bolmo</span><span class="p">:</span></span>
<span class="num"><a href="#241">241</a></span><span class="full not_run">                    <span class="n">epilogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bolmo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span></span>
<span class="num"><a href="#242">242</a></span><span class="full not_run">            <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">epilogue</span> <span class="o">=</span> <span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span></span>
<span class="num"><a href="#243">243</a></span><span class="full not_run">            <span class="k">return</span></span>
<span class="num"><a href="#244">244</a></span><span>        <span class="c1"># Otherwise, it&#39;s some non-multipart type, so the entire rest of the</span></span>
<span class="num"><a href="#245">245</a></span><span>        <span class="c1"># file contents becomes the payload.</span></span>
<span class="num"><a href="#246">246</a></span><span class="full not_run">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span></span>
<span class="num"><a href="#247">247</a></span><span class="full not_run">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">:</span></span>
<span class="num"><a href="#248">248</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">NeedMoreData</span><span class="p">:</span></span>
<span class="num"><a href="#249">249</a></span><span class="full not_run">                <span class="k">yield</span> <span class="n">NeedMoreData</span></span>
<span class="num"><a href="#250">250</a></span><span class="full not_run">                <span class="k">continue</span></span>
<span class="num"><a href="#251">251</a></span><span class="full not_run">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></span>
<span class="num"><a href="#252">252</a></span><span class="full not_run">        <span class="bp">self</span><span class="o">.</span><span class="n">_cur</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">EMPTYSTRING</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></span>
            </pre>
    </div>
</div>
<i class="bi bi-arrow-down"></i>
</body>
</html>
