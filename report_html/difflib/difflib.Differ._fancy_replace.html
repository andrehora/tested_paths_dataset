<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>difflib.Differ._fancy_replace</title>
    <meta http-equiv="X-UA-Compatible" content="IE=emulateIE7" />
<!--    <link rel="icon" sizes="32x32" href="favicon_32.png">-->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>&#128270;</text></svg>">
    <link rel="stylesheet" href="highlight.css" type="text/css">
</head>
<body class="pyfile">
<div id="source">
    <div class="highlight">
        <div id="header">
            <div class="content">
                <h1>Method: difflib.Differ._fancy_replace</h1>
                <span>Calls: 100, </span>
                <span>Exceptions: 0, </span>
                <span>Paths: 9</span>
                <br><a href="index.html">Back</a>
            </div>
        </div>
            <p><b>Path 1</b>: 45 calls (0.45)</p>
                <p><button class="input"><span>&#8594;</span> a</button> ['line 0', '1234567890123456789012345689012345', 'line 1', 'line 2', 'line 3', 'line 4   changed', 'line 5   changed', 'line 6   changed', 'line 7', '...</p>
                <p><button class="input"><span>&#8594;</span> alo</button> 1 (13) 11 (7) 16 (4) 31 (4) 0 (4) 5 (3) 6 (3) 7 (3) 3 (2) 26 (1) </p>
                <p><button class="input"><span>&#8594;</span> ahi</button> 8 (9) 3 (7) 2 (5) 18 (4) 33 (4) 4 (4) 15 (3) 14 (3) 5 (2) 13 (1) </p>
                <p><button class="input"><span>&#8594;</span> b</button> ['line 0', '1234567890123456789012345689012345', 'line 1', 'line 2    added', 'line 3', 'line 4   chanGEd', 'line 5a  chanGed', 'line 6a  changEd', 'l...</p>
                <p><button class="input"><span>&#8594;</span> blo</button> 1 (13) 11 (7) 16 (4) 31 (4) 0 (4) 5 (3) 6 (3) 7 (3) 3 (2) 26 (1) </p>
                <p><button class="input"><span>&#8594;</span> bhi</button> 2 (9) 8 (9) 17 (4) 32 (4) 4 (4) 1 (4) 15 (3) 14 (3) 5 (2) 12 (1) </p>
                <p><button class="output"><span>&#8647; yield</span></button> None (45) '?                      ^^\n' (34) '-    1. Beautiful is beTTer than ugly.' (18) '?       ^       ^\n' (18) '+    1. Beautiful is better tha...</p>
            <button class="run" title="lines run...">33 run</button>
            <button class="not_run" title="lines not run...">11 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_fancy_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">alo</span><span class="p">,</span> <span class="n">ahi</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blo</span><span class="p">,</span> <span class="n">bhi</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span></span>
<span class="num"><a href="#3">3</a></span><span><span class="sd">        When replacing one block of lines with another, search the blocks</span></span>
<span class="num"><a href="#4">4</a></span><span><span class="sd">        for *similar* lines; the best-matching pair (if any) is used as a</span></span>
<span class="num"><a href="#5">5</a></span><span><span class="sd">        synch point, and intraline difference marking is done on the</span></span>
<span class="num"><a href="#6">6</a></span><span><span class="sd">        similar pair. Lots of work, but often worth it.</span></span>
<span class="num"><a href="#7">7</a></span><span></span>
<span class="num"><a href="#8">8</a></span><span><span class="sd">        Example:</span></span>
<span class="num"><a href="#9">9</a></span><span></span>
<span class="num"><a href="#10">10</a></span><span><span class="sd">        &gt;&gt;&gt; d = Differ()</span></span>
<span class="num"><a href="#11">11</a></span><span><span class="sd">        &gt;&gt;&gt; results = d._fancy_replace([&#39;abcDefghiJkl\n&#39;], 0, 1,</span></span>
<span class="num"><a href="#12">12</a></span><span><span class="sd">        ...                            [&#39;abcdefGhijkl\n&#39;], 0, 1)</span></span>
<span class="num"><a href="#13">13</a></span><span><span class="sd">        &gt;&gt;&gt; print(&#39;&#39;.join(results), end=&quot;&quot;)</span></span>
<span class="num"><a href="#14">14</a></span><span><span class="sd">        - abcDefghiJkl</span></span>
<span class="num"><a href="#15">15</a></span><span><span class="sd">        ?    ^  ^  ^</span></span>
<span class="num"><a href="#16">16</a></span><span><span class="sd">        + abcdefGhijkl</span></span>
<span class="num"><a href="#17">17</a></span><span><span class="sd">        ?    ^  ^  ^</span></span>
<span class="num"><a href="#18">18</a></span><span><span class="sd">        &quot;&quot;&quot;</span></span>
<span class="num"><a href="#19">19</a></span><span></span>
<span class="num"><a href="#20">20</a></span><span>        <span class="c1"># don&#39;t synch up unless the lines have a similarity score of at</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># least cutoff; best_ratio tracks the best score seen so far</span></span>
<span class="num"><a href="#22">22</a></span><span class="full run">        <span class="n">best_ratio</span><span class="p">,</span> <span class="n">cutoff</span> <span class="o">=</span> <span class="mf">0.74</span><span class="p">,</span> <span class="mf">0.75</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="n">cruncher</span> <span class="o">=</span> <span class="n">SequenceMatcher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charjunk</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span class="full run">        <span class="n">eqi</span><span class="p">,</span> <span class="n">eqj</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>   <span class="c1"># 1st indices of equal lines (if any)</span></span>
<span class="num"><a href="#25">25</a></span><span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># search for the pair that matches best without being identical</span></span>
<span class="num"><a href="#27">27</a></span><span>        <span class="c1"># (identical lines must be junk lines, &amp; we don&#39;t want to synch up</span></span>
<span class="num"><a href="#28">28</a></span><span>        <span class="c1"># on junk -- unless we have to)</span></span>
<span class="num"><a href="#29">29</a></span><span class="full run">        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">blo</span><span class="p">,</span> <span class="n">bhi</span><span class="p">):</span></span>
<span class="num"><a href="#30">30</a></span><span class="full run">            <span class="n">bj</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">]</span></span>
<span class="num"><a href="#31">31</a></span><span class="full run">            <span class="n">cruncher</span><span class="o">.</span><span class="n">set_seq2</span><span class="p">(</span><span class="n">bj</span><span class="p">)</span></span>
<span class="num"><a href="#32">32</a></span><span class="full run">            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">alo</span><span class="p">,</span> <span class="n">ahi</span><span class="p">):</span></span>
<span class="num"><a href="#33">33</a></span><span class="full run">                <span class="n">ai</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></span>
<span class="num"><a href="#34">34</a></span><span class="full run">                <span class="k">if</span> <span class="n">ai</span> <span class="o">==</span> <span class="n">bj</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">eqi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                        <span class="n">eqi</span><span class="p">,</span> <span class="n">eqj</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#38">38</a></span><span class="full run">                <span class="n">cruncher</span><span class="o">.</span><span class="n">set_seq1</span><span class="p">(</span><span class="n">ai</span><span class="p">)</span></span>
<span class="num"><a href="#39">39</a></span><span>                <span class="c1"># computing similarity is expensive, so use the quick</span></span>
<span class="num"><a href="#40">40</a></span><span>                <span class="c1"># upper bounds first -- have seen this speed up messy</span></span>
<span class="num"><a href="#41">41</a></span><span>                <span class="c1"># compares by a factor of 3.</span></span>
<span class="num"><a href="#42">42</a></span><span>                <span class="c1"># note that ratio() is only expensive to compute the first</span></span>
<span class="num"><a href="#43">43</a></span><span>                <span class="c1"># time it&#39;s called on a sequence pair; the expensive part</span></span>
<span class="num"><a href="#44">44</a></span><span>                <span class="c1"># of the computation is cached by cruncher</span></span>
<span class="num"><a href="#45">45</a></span><span class="full run">                <span class="k">if</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">real_quick_ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">best_ratio</span> <span class="ow">and</span> \</span>
<span class="num"><a href="#46">46</a></span><span class="full run">                      <span class="n">cruncher</span><span class="o">.</span><span class="n">quick_ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">best_ratio</span> <span class="ow">and</span> \</span>
<span class="num"><a href="#47">47</a></span><span class="full run">                      <span class="n">cruncher</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">best_ratio</span><span class="p">:</span></span>
<span class="num"><a href="#48">48</a></span><span class="full run">                    <span class="n">best_ratio</span><span class="p">,</span> <span class="n">best_i</span><span class="p">,</span> <span class="n">best_j</span> <span class="o">=</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">ratio</span><span class="p">(),</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span></span>
<span class="num"><a href="#49">49</a></span><span class="full run">        <span class="k">if</span> <span class="n">best_ratio</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">:</span></span>
<span class="num"><a href="#50">50</a></span><span>            <span class="c1"># no non-identical &quot;pretty close&quot; pair</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">eqi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#52">52</a></span><span>                <span class="c1"># no identical pair either -- treat it as a straight replace</span></span>
<span class="num"><a href="#53">53</a></span><span class="full not_run">                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plain_replace</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">alo</span><span class="p">,</span> <span class="n">ahi</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blo</span><span class="p">,</span> <span class="n">bhi</span><span class="p">)</span></span>
<span class="num"><a href="#54">54</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#55">55</a></span><span>            <span class="c1"># no close pair, but an identical pair -- synch up on that</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">            <span class="n">best_i</span><span class="p">,</span> <span class="n">best_j</span><span class="p">,</span> <span class="n">best_ratio</span> <span class="o">=</span> <span class="n">eqi</span><span class="p">,</span> <span class="n">eqj</span><span class="p">,</span> <span class="mf">1.0</span></span>
<span class="num"><a href="#57">57</a></span><span>        <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#58">58</a></span><span>            <span class="c1"># there&#39;s a close pair, so forget the identical pair (if any)</span></span>
<span class="num"><a href="#59">59</a></span><span class="full run">            <span class="n">eqi</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#60">60</a></span><span></span>
<span class="num"><a href="#61">61</a></span><span>        <span class="c1"># a[best_i] very similar to b[best_j]; eqi is None iff they&#39;re not</span></span>
<span class="num"><a href="#62">62</a></span><span>        <span class="c1"># identical</span></span>
<span class="num"><a href="#63">63</a></span><span></span>
<span class="num"><a href="#64">64</a></span><span>        <span class="c1"># pump out diffs from before the synch point</span></span>
<span class="num"><a href="#65">65</a></span><span class="full run">        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fancy_helper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">alo</span><span class="p">,</span> <span class="n">best_i</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blo</span><span class="p">,</span> <span class="n">best_j</span><span class="p">)</span></span>
<span class="num"><a href="#66">66</a></span><span></span>
<span class="num"><a href="#67">67</a></span><span>        <span class="c1"># do intraline marking on the synch pair</span></span>
<span class="num"><a href="#68">68</a></span><span class="full run">        <span class="n">aelt</span><span class="p">,</span> <span class="n">belt</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">best_i</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">best_j</span><span class="p">]</span></span>
<span class="num"><a href="#69">69</a></span><span class="full run">        <span class="k">if</span> <span class="n">eqi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span>            <span class="c1"># pump out a &#39;-&#39;, &#39;?&#39;, &#39;+&#39;, &#39;?&#39; quad for the synched lines</span></span>
<span class="num"><a href="#71">71</a></span><span class="full run">            <span class="n">atags</span> <span class="o">=</span> <span class="n">btags</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span></span>
<span class="num"><a href="#72">72</a></span><span class="full run">            <span class="n">cruncher</span><span class="o">.</span><span class="n">set_seqs</span><span class="p">(</span><span class="n">aelt</span><span class="p">,</span> <span class="n">belt</span><span class="p">)</span></span>
<span class="num"><a href="#73">73</a></span><span class="full run">            <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">ai1</span><span class="p">,</span> <span class="n">ai2</span><span class="p">,</span> <span class="n">bj1</span><span class="p">,</span> <span class="n">bj2</span> <span class="ow">in</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">get_opcodes</span><span class="p">():</span></span>
<span class="num"><a href="#74">74</a></span><span class="full run">                <span class="n">la</span><span class="p">,</span> <span class="n">lb</span> <span class="o">=</span> <span class="n">ai2</span> <span class="o">-</span> <span class="n">ai1</span><span class="p">,</span> <span class="n">bj2</span> <span class="o">-</span> <span class="n">bj1</span></span>
<span class="num"><a href="#75">75</a></span><span class="full run">                <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;replace&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#76">76</a></span><span class="full run">                    <span class="n">atags</span> <span class="o">+=</span> <span class="s1">&#39;^&#39;</span> <span class="o">*</span> <span class="n">la</span></span>
<span class="num"><a href="#77">77</a></span><span class="full run">                    <span class="n">btags</span> <span class="o">+=</span> <span class="s1">&#39;^&#39;</span> <span class="o">*</span> <span class="n">lb</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span class="full not_run">                    <span class="n">atags</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="n">la</span></span>
<span class="num"><a href="#80">80</a></span><span class="full run">                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;insert&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">                    <span class="n">btags</span> <span class="o">+=</span> <span class="s1">&#39;+&#39;</span> <span class="o">*</span> <span class="n">lb</span></span>
<span class="num"><a href="#82">82</a></span><span class="full run">                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;equal&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full run">                    <span class="n">atags</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">la</span></span>
<span class="num"><a href="#84">84</a></span><span class="full run">                    <span class="n">btags</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">lb</span></span>
<span class="num"><a href="#85">85</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unknown tag </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,))</span></span>
<span class="num"><a href="#87">87</a></span><span class="full run">            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qformat</span><span class="p">(</span><span class="n">aelt</span><span class="p">,</span> <span class="n">belt</span><span class="p">,</span> <span class="n">atags</span><span class="p">,</span> <span class="n">btags</span><span class="p">)</span></span>
<span class="num"><a href="#88">88</a></span><span>        <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span>            <span class="c1"># the synch pair is identical</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">yield</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">aelt</span></span>
<span class="num"><a href="#91">91</a></span><span></span>
<span class="num"><a href="#92">92</a></span><span>        <span class="c1"># pump out diffs from after the synch point</span></span>
<span class="num"><a href="#93">93</a></span><span class="full run">        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fancy_helper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">best_i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ahi</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">best_j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">bhi</span><span class="p">)</span></span>
            </pre>
            <p><b>Path 2</b>: 19 calls (0.19)</p>
                <p><button class="input"><span>&#8594;</span> a</button> ['', '   1. Beautiful is beTTer than ugly.', '   2. Explicit is better than implicit.', '   3. Simple is better than complex.', '   4. Complex is bett...</p>
                <p><button class="input"><span>&#8594;</span> alo</button> 1 (7) 16 (4) 31 (4) 0 (1) 11 (1) 26 (1) 41 (1) </p>
                <p><button class="input"><span>&#8594;</span> ahi</button> 5 (6) 20 (4) 35 (4) 1 (1) 15 (1) 30 (1) 45 (1) 4 (1) </p>
                <p><button class="input"><span>&#8594;</span> b</button> ['', '   1. Beautiful is better than ugly.', '   3.   Simple is better than complex.', '   4. Complicated is better than complex.', '   5. Flat is bet...</p>
                <p><button class="input"><span>&#8594;</span> blo</button> 1 (7) 16 (4) 31 (4) 0 (1) 11 (1) 26 (1) 41 (1) </p>
                <p><button class="input"><span>&#8594;</span> bhi</button> 5 (6) 20 (4) 35 (4) 1 (1) 15 (1) 30 (1) 45 (1) 4 (1) </p>
                <p><button class="output"><span>&#8647; yield</span></button> '?                      ^^\n' (34) None (19) '-    1. Beautiful is beTTer than ugly.' (17) '+    1. Beautiful is better than ugly.' (17) '-    2. Expl...</p>
            <button class="run" title="lines run...">32 run</button>
            <button class="not_run" title="lines not run...">12 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_fancy_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">alo</span><span class="p">,</span> <span class="n">ahi</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blo</span><span class="p">,</span> <span class="n">bhi</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span></span>
<span class="num"><a href="#3">3</a></span><span><span class="sd">        When replacing one block of lines with another, search the blocks</span></span>
<span class="num"><a href="#4">4</a></span><span><span class="sd">        for *similar* lines; the best-matching pair (if any) is used as a</span></span>
<span class="num"><a href="#5">5</a></span><span><span class="sd">        synch point, and intraline difference marking is done on the</span></span>
<span class="num"><a href="#6">6</a></span><span><span class="sd">        similar pair. Lots of work, but often worth it.</span></span>
<span class="num"><a href="#7">7</a></span><span></span>
<span class="num"><a href="#8">8</a></span><span><span class="sd">        Example:</span></span>
<span class="num"><a href="#9">9</a></span><span></span>
<span class="num"><a href="#10">10</a></span><span><span class="sd">        &gt;&gt;&gt; d = Differ()</span></span>
<span class="num"><a href="#11">11</a></span><span><span class="sd">        &gt;&gt;&gt; results = d._fancy_replace([&#39;abcDefghiJkl\n&#39;], 0, 1,</span></span>
<span class="num"><a href="#12">12</a></span><span><span class="sd">        ...                            [&#39;abcdefGhijkl\n&#39;], 0, 1)</span></span>
<span class="num"><a href="#13">13</a></span><span><span class="sd">        &gt;&gt;&gt; print(&#39;&#39;.join(results), end=&quot;&quot;)</span></span>
<span class="num"><a href="#14">14</a></span><span><span class="sd">        - abcDefghiJkl</span></span>
<span class="num"><a href="#15">15</a></span><span><span class="sd">        ?    ^  ^  ^</span></span>
<span class="num"><a href="#16">16</a></span><span><span class="sd">        + abcdefGhijkl</span></span>
<span class="num"><a href="#17">17</a></span><span><span class="sd">        ?    ^  ^  ^</span></span>
<span class="num"><a href="#18">18</a></span><span><span class="sd">        &quot;&quot;&quot;</span></span>
<span class="num"><a href="#19">19</a></span><span></span>
<span class="num"><a href="#20">20</a></span><span>        <span class="c1"># don&#39;t synch up unless the lines have a similarity score of at</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># least cutoff; best_ratio tracks the best score seen so far</span></span>
<span class="num"><a href="#22">22</a></span><span class="full run">        <span class="n">best_ratio</span><span class="p">,</span> <span class="n">cutoff</span> <span class="o">=</span> <span class="mf">0.74</span><span class="p">,</span> <span class="mf">0.75</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="n">cruncher</span> <span class="o">=</span> <span class="n">SequenceMatcher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charjunk</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span class="full run">        <span class="n">eqi</span><span class="p">,</span> <span class="n">eqj</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>   <span class="c1"># 1st indices of equal lines (if any)</span></span>
<span class="num"><a href="#25">25</a></span><span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># search for the pair that matches best without being identical</span></span>
<span class="num"><a href="#27">27</a></span><span>        <span class="c1"># (identical lines must be junk lines, &amp; we don&#39;t want to synch up</span></span>
<span class="num"><a href="#28">28</a></span><span>        <span class="c1"># on junk -- unless we have to)</span></span>
<span class="num"><a href="#29">29</a></span><span class="full run">        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">blo</span><span class="p">,</span> <span class="n">bhi</span><span class="p">):</span></span>
<span class="num"><a href="#30">30</a></span><span class="full run">            <span class="n">bj</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">]</span></span>
<span class="num"><a href="#31">31</a></span><span class="full run">            <span class="n">cruncher</span><span class="o">.</span><span class="n">set_seq2</span><span class="p">(</span><span class="n">bj</span><span class="p">)</span></span>
<span class="num"><a href="#32">32</a></span><span class="full run">            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">alo</span><span class="p">,</span> <span class="n">ahi</span><span class="p">):</span></span>
<span class="num"><a href="#33">33</a></span><span class="full run">                <span class="n">ai</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></span>
<span class="num"><a href="#34">34</a></span><span class="full run">                <span class="k">if</span> <span class="n">ai</span> <span class="o">==</span> <span class="n">bj</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">eqi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                        <span class="n">eqi</span><span class="p">,</span> <span class="n">eqj</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#38">38</a></span><span class="full run">                <span class="n">cruncher</span><span class="o">.</span><span class="n">set_seq1</span><span class="p">(</span><span class="n">ai</span><span class="p">)</span></span>
<span class="num"><a href="#39">39</a></span><span>                <span class="c1"># computing similarity is expensive, so use the quick</span></span>
<span class="num"><a href="#40">40</a></span><span>                <span class="c1"># upper bounds first -- have seen this speed up messy</span></span>
<span class="num"><a href="#41">41</a></span><span>                <span class="c1"># compares by a factor of 3.</span></span>
<span class="num"><a href="#42">42</a></span><span>                <span class="c1"># note that ratio() is only expensive to compute the first</span></span>
<span class="num"><a href="#43">43</a></span><span>                <span class="c1"># time it&#39;s called on a sequence pair; the expensive part</span></span>
<span class="num"><a href="#44">44</a></span><span>                <span class="c1"># of the computation is cached by cruncher</span></span>
<span class="num"><a href="#45">45</a></span><span class="full run">                <span class="k">if</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">real_quick_ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">best_ratio</span> <span class="ow">and</span> \</span>
<span class="num"><a href="#46">46</a></span><span class="full run">                      <span class="n">cruncher</span><span class="o">.</span><span class="n">quick_ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">best_ratio</span> <span class="ow">and</span> \</span>
<span class="num"><a href="#47">47</a></span><span class="full run">                      <span class="n">cruncher</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">best_ratio</span><span class="p">:</span></span>
<span class="num"><a href="#48">48</a></span><span class="full run">                    <span class="n">best_ratio</span><span class="p">,</span> <span class="n">best_i</span><span class="p">,</span> <span class="n">best_j</span> <span class="o">=</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">ratio</span><span class="p">(),</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span></span>
<span class="num"><a href="#49">49</a></span><span class="full run">        <span class="k">if</span> <span class="n">best_ratio</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">:</span></span>
<span class="num"><a href="#50">50</a></span><span>            <span class="c1"># no non-identical &quot;pretty close&quot; pair</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">eqi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#52">52</a></span><span>                <span class="c1"># no identical pair either -- treat it as a straight replace</span></span>
<span class="num"><a href="#53">53</a></span><span class="full not_run">                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plain_replace</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">alo</span><span class="p">,</span> <span class="n">ahi</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blo</span><span class="p">,</span> <span class="n">bhi</span><span class="p">)</span></span>
<span class="num"><a href="#54">54</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#55">55</a></span><span>            <span class="c1"># no close pair, but an identical pair -- synch up on that</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">            <span class="n">best_i</span><span class="p">,</span> <span class="n">best_j</span><span class="p">,</span> <span class="n">best_ratio</span> <span class="o">=</span> <span class="n">eqi</span><span class="p">,</span> <span class="n">eqj</span><span class="p">,</span> <span class="mf">1.0</span></span>
<span class="num"><a href="#57">57</a></span><span>        <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#58">58</a></span><span>            <span class="c1"># there&#39;s a close pair, so forget the identical pair (if any)</span></span>
<span class="num"><a href="#59">59</a></span><span class="full run">            <span class="n">eqi</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#60">60</a></span><span></span>
<span class="num"><a href="#61">61</a></span><span>        <span class="c1"># a[best_i] very similar to b[best_j]; eqi is None iff they&#39;re not</span></span>
<span class="num"><a href="#62">62</a></span><span>        <span class="c1"># identical</span></span>
<span class="num"><a href="#63">63</a></span><span></span>
<span class="num"><a href="#64">64</a></span><span>        <span class="c1"># pump out diffs from before the synch point</span></span>
<span class="num"><a href="#65">65</a></span><span class="full run">        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fancy_helper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">alo</span><span class="p">,</span> <span class="n">best_i</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blo</span><span class="p">,</span> <span class="n">best_j</span><span class="p">)</span></span>
<span class="num"><a href="#66">66</a></span><span></span>
<span class="num"><a href="#67">67</a></span><span>        <span class="c1"># do intraline marking on the synch pair</span></span>
<span class="num"><a href="#68">68</a></span><span class="full run">        <span class="n">aelt</span><span class="p">,</span> <span class="n">belt</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">best_i</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">best_j</span><span class="p">]</span></span>
<span class="num"><a href="#69">69</a></span><span class="full run">        <span class="k">if</span> <span class="n">eqi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span>            <span class="c1"># pump out a &#39;-&#39;, &#39;?&#39;, &#39;+&#39;, &#39;?&#39; quad for the synched lines</span></span>
<span class="num"><a href="#71">71</a></span><span class="full run">            <span class="n">atags</span> <span class="o">=</span> <span class="n">btags</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span></span>
<span class="num"><a href="#72">72</a></span><span class="full run">            <span class="n">cruncher</span><span class="o">.</span><span class="n">set_seqs</span><span class="p">(</span><span class="n">aelt</span><span class="p">,</span> <span class="n">belt</span><span class="p">)</span></span>
<span class="num"><a href="#73">73</a></span><span class="full run">            <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">ai1</span><span class="p">,</span> <span class="n">ai2</span><span class="p">,</span> <span class="n">bj1</span><span class="p">,</span> <span class="n">bj2</span> <span class="ow">in</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">get_opcodes</span><span class="p">():</span></span>
<span class="num"><a href="#74">74</a></span><span class="full run">                <span class="n">la</span><span class="p">,</span> <span class="n">lb</span> <span class="o">=</span> <span class="n">ai2</span> <span class="o">-</span> <span class="n">ai1</span><span class="p">,</span> <span class="n">bj2</span> <span class="o">-</span> <span class="n">bj1</span></span>
<span class="num"><a href="#75">75</a></span><span class="full run">                <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;replace&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                    <span class="n">atags</span> <span class="o">+=</span> <span class="s1">&#39;^&#39;</span> <span class="o">*</span> <span class="n">la</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">                    <span class="n">btags</span> <span class="o">+=</span> <span class="s1">&#39;^&#39;</span> <span class="o">*</span> <span class="n">lb</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span class="full not_run">                    <span class="n">atags</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="n">la</span></span>
<span class="num"><a href="#80">80</a></span><span class="full run">                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;insert&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#81">81</a></span><span class="full run">                    <span class="n">btags</span> <span class="o">+=</span> <span class="s1">&#39;+&#39;</span> <span class="o">*</span> <span class="n">lb</span></span>
<span class="num"><a href="#82">82</a></span><span class="full run">                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;equal&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full run">                    <span class="n">atags</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">la</span></span>
<span class="num"><a href="#84">84</a></span><span class="full run">                    <span class="n">btags</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">lb</span></span>
<span class="num"><a href="#85">85</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unknown tag </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,))</span></span>
<span class="num"><a href="#87">87</a></span><span class="full run">            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qformat</span><span class="p">(</span><span class="n">aelt</span><span class="p">,</span> <span class="n">belt</span><span class="p">,</span> <span class="n">atags</span><span class="p">,</span> <span class="n">btags</span><span class="p">)</span></span>
<span class="num"><a href="#88">88</a></span><span>        <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span>            <span class="c1"># the synch pair is identical</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">yield</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">aelt</span></span>
<span class="num"><a href="#91">91</a></span><span></span>
<span class="num"><a href="#92">92</a></span><span>        <span class="c1"># pump out diffs from after the synch point</span></span>
<span class="num"><a href="#93">93</a></span><span class="full run">        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fancy_helper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">best_i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ahi</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">best_j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">bhi</span><span class="p">)</span></span>
            </pre>
            <p><b>Path 3</b>: 18 calls (0.18)</p>
                <p><button class="input"><span>&#8594;</span> a</button> ['', '   1. Beautiful is beTTer than ugly.', '   2. Explicit is better than implicit.', '   3. Simple is better than complex.', '   4. Complex is bett...</p>
                <p><button class="input"><span>&#8594;</span> alo</button> 4 (7) 19 (4) 34 (4) 14 (1) 29 (1) 44 (1) </p>
                <p><button class="input"><span>&#8594;</span> ahi</button> 5 (7) 20 (4) 35 (4) 15 (1) 30 (1) 45 (1) </p>
                <p><button class="input"><span>&#8594;</span> b</button> ['', '   1. Beautiful is better than ugly.', '   3.   Simple is better than complex.', '   4. Complicated is better than complex.', '   5. Flat is bet...</p>
                <p><button class="input"><span>&#8594;</span> blo</button> 3 (7) 18 (4) 33 (4) 13 (1) 28 (1) 43 (1) </p>
                <p><button class="input"><span>&#8594;</span> bhi</button> 5 (7) 20 (4) 35 (4) 15 (1) 30 (1) 45 (1) </p>
                <p><button class="output"><span>&#8647; yield</span></button> '-    4. Complex is better than complicated.' (18) '+    5. Flat is better than nested.' (18) '+    4. Complicated is better than complex.' (17) '+   ...</p>
                <p><button class="output"><span>&#8617; return</span></button> None (18) </p>
            <button class="run" title="lines run...">17 run</button>
            <button class="not_run" title="lines not run...">27 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_fancy_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">alo</span><span class="p">,</span> <span class="n">ahi</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blo</span><span class="p">,</span> <span class="n">bhi</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span></span>
<span class="num"><a href="#3">3</a></span><span><span class="sd">        When replacing one block of lines with another, search the blocks</span></span>
<span class="num"><a href="#4">4</a></span><span><span class="sd">        for *similar* lines; the best-matching pair (if any) is used as a</span></span>
<span class="num"><a href="#5">5</a></span><span><span class="sd">        synch point, and intraline difference marking is done on the</span></span>
<span class="num"><a href="#6">6</a></span><span><span class="sd">        similar pair. Lots of work, but often worth it.</span></span>
<span class="num"><a href="#7">7</a></span><span></span>
<span class="num"><a href="#8">8</a></span><span><span class="sd">        Example:</span></span>
<span class="num"><a href="#9">9</a></span><span></span>
<span class="num"><a href="#10">10</a></span><span><span class="sd">        &gt;&gt;&gt; d = Differ()</span></span>
<span class="num"><a href="#11">11</a></span><span><span class="sd">        &gt;&gt;&gt; results = d._fancy_replace([&#39;abcDefghiJkl\n&#39;], 0, 1,</span></span>
<span class="num"><a href="#12">12</a></span><span><span class="sd">        ...                            [&#39;abcdefGhijkl\n&#39;], 0, 1)</span></span>
<span class="num"><a href="#13">13</a></span><span><span class="sd">        &gt;&gt;&gt; print(&#39;&#39;.join(results), end=&quot;&quot;)</span></span>
<span class="num"><a href="#14">14</a></span><span><span class="sd">        - abcDefghiJkl</span></span>
<span class="num"><a href="#15">15</a></span><span><span class="sd">        ?    ^  ^  ^</span></span>
<span class="num"><a href="#16">16</a></span><span><span class="sd">        + abcdefGhijkl</span></span>
<span class="num"><a href="#17">17</a></span><span><span class="sd">        ?    ^  ^  ^</span></span>
<span class="num"><a href="#18">18</a></span><span><span class="sd">        &quot;&quot;&quot;</span></span>
<span class="num"><a href="#19">19</a></span><span></span>
<span class="num"><a href="#20">20</a></span><span>        <span class="c1"># don&#39;t synch up unless the lines have a similarity score of at</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># least cutoff; best_ratio tracks the best score seen so far</span></span>
<span class="num"><a href="#22">22</a></span><span class="full run">        <span class="n">best_ratio</span><span class="p">,</span> <span class="n">cutoff</span> <span class="o">=</span> <span class="mf">0.74</span><span class="p">,</span> <span class="mf">0.75</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="n">cruncher</span> <span class="o">=</span> <span class="n">SequenceMatcher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charjunk</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span class="full run">        <span class="n">eqi</span><span class="p">,</span> <span class="n">eqj</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>   <span class="c1"># 1st indices of equal lines (if any)</span></span>
<span class="num"><a href="#25">25</a></span><span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># search for the pair that matches best without being identical</span></span>
<span class="num"><a href="#27">27</a></span><span>        <span class="c1"># (identical lines must be junk lines, &amp; we don&#39;t want to synch up</span></span>
<span class="num"><a href="#28">28</a></span><span>        <span class="c1"># on junk -- unless we have to)</span></span>
<span class="num"><a href="#29">29</a></span><span class="full run">        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">blo</span><span class="p">,</span> <span class="n">bhi</span><span class="p">):</span></span>
<span class="num"><a href="#30">30</a></span><span class="full run">            <span class="n">bj</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">]</span></span>
<span class="num"><a href="#31">31</a></span><span class="full run">            <span class="n">cruncher</span><span class="o">.</span><span class="n">set_seq2</span><span class="p">(</span><span class="n">bj</span><span class="p">)</span></span>
<span class="num"><a href="#32">32</a></span><span class="full run">            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">alo</span><span class="p">,</span> <span class="n">ahi</span><span class="p">):</span></span>
<span class="num"><a href="#33">33</a></span><span class="full run">                <span class="n">ai</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></span>
<span class="num"><a href="#34">34</a></span><span class="full run">                <span class="k">if</span> <span class="n">ai</span> <span class="o">==</span> <span class="n">bj</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">eqi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                        <span class="n">eqi</span><span class="p">,</span> <span class="n">eqj</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#38">38</a></span><span class="full run">                <span class="n">cruncher</span><span class="o">.</span><span class="n">set_seq1</span><span class="p">(</span><span class="n">ai</span><span class="p">)</span></span>
<span class="num"><a href="#39">39</a></span><span>                <span class="c1"># computing similarity is expensive, so use the quick</span></span>
<span class="num"><a href="#40">40</a></span><span>                <span class="c1"># upper bounds first -- have seen this speed up messy</span></span>
<span class="num"><a href="#41">41</a></span><span>                <span class="c1"># compares by a factor of 3.</span></span>
<span class="num"><a href="#42">42</a></span><span>                <span class="c1"># note that ratio() is only expensive to compute the first</span></span>
<span class="num"><a href="#43">43</a></span><span>                <span class="c1"># time it&#39;s called on a sequence pair; the expensive part</span></span>
<span class="num"><a href="#44">44</a></span><span>                <span class="c1"># of the computation is cached by cruncher</span></span>
<span class="num"><a href="#45">45</a></span><span class="full run">                <span class="k">if</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">real_quick_ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">best_ratio</span> <span class="ow">and</span> \</span>
<span class="num"><a href="#46">46</a></span><span class="full run">                      <span class="n">cruncher</span><span class="o">.</span><span class="n">quick_ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">best_ratio</span> <span class="ow">and</span> \</span>
<span class="num"><a href="#47">47</a></span><span class="full run">                      <span class="n">cruncher</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">best_ratio</span><span class="p">:</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="n">best_ratio</span><span class="p">,</span> <span class="n">best_i</span><span class="p">,</span> <span class="n">best_j</span> <span class="o">=</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">ratio</span><span class="p">(),</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span></span>
<span class="num"><a href="#49">49</a></span><span class="full run">        <span class="k">if</span> <span class="n">best_ratio</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">:</span></span>
<span class="num"><a href="#50">50</a></span><span>            <span class="c1"># no non-identical &quot;pretty close&quot; pair</span></span>
<span class="num"><a href="#51">51</a></span><span class="full run">            <span class="k">if</span> <span class="n">eqi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#52">52</a></span><span>                <span class="c1"># no identical pair either -- treat it as a straight replace</span></span>
<span class="num"><a href="#53">53</a></span><span class="full run">                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plain_replace</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">alo</span><span class="p">,</span> <span class="n">ahi</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blo</span><span class="p">,</span> <span class="n">bhi</span><span class="p">)</span></span>
<span class="num"><a href="#54">54</a></span><span class="full run">                <span class="k">return</span></span>
<span class="num"><a href="#55">55</a></span><span>            <span class="c1"># no close pair, but an identical pair -- synch up on that</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">            <span class="n">best_i</span><span class="p">,</span> <span class="n">best_j</span><span class="p">,</span> <span class="n">best_ratio</span> <span class="o">=</span> <span class="n">eqi</span><span class="p">,</span> <span class="n">eqj</span><span class="p">,</span> <span class="mf">1.0</span></span>
<span class="num"><a href="#57">57</a></span><span>        <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#58">58</a></span><span>            <span class="c1"># there&#39;s a close pair, so forget the identical pair (if any)</span></span>
<span class="num"><a href="#59">59</a></span><span class="full not_run">            <span class="n">eqi</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#60">60</a></span><span></span>
<span class="num"><a href="#61">61</a></span><span>        <span class="c1"># a[best_i] very similar to b[best_j]; eqi is None iff they&#39;re not</span></span>
<span class="num"><a href="#62">62</a></span><span>        <span class="c1"># identical</span></span>
<span class="num"><a href="#63">63</a></span><span></span>
<span class="num"><a href="#64">64</a></span><span>        <span class="c1"># pump out diffs from before the synch point</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fancy_helper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">alo</span><span class="p">,</span> <span class="n">best_i</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blo</span><span class="p">,</span> <span class="n">best_j</span><span class="p">)</span></span>
<span class="num"><a href="#66">66</a></span><span></span>
<span class="num"><a href="#67">67</a></span><span>        <span class="c1"># do intraline marking on the synch pair</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">        <span class="n">aelt</span><span class="p">,</span> <span class="n">belt</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">best_i</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">best_j</span><span class="p">]</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">        <span class="k">if</span> <span class="n">eqi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span>            <span class="c1"># pump out a &#39;-&#39;, &#39;?&#39;, &#39;+&#39;, &#39;?&#39; quad for the synched lines</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">            <span class="n">atags</span> <span class="o">=</span> <span class="n">btags</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">            <span class="n">cruncher</span><span class="o">.</span><span class="n">set_seqs</span><span class="p">(</span><span class="n">aelt</span><span class="p">,</span> <span class="n">belt</span><span class="p">)</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">ai1</span><span class="p">,</span> <span class="n">ai2</span><span class="p">,</span> <span class="n">bj1</span><span class="p">,</span> <span class="n">bj2</span> <span class="ow">in</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">get_opcodes</span><span class="p">():</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                <span class="n">la</span><span class="p">,</span> <span class="n">lb</span> <span class="o">=</span> <span class="n">ai2</span> <span class="o">-</span> <span class="n">ai1</span><span class="p">,</span> <span class="n">bj2</span> <span class="o">-</span> <span class="n">bj1</span></span>
<span class="num"><a href="#75">75</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;replace&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                    <span class="n">atags</span> <span class="o">+=</span> <span class="s1">&#39;^&#39;</span> <span class="o">*</span> <span class="n">la</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">                    <span class="n">btags</span> <span class="o">+=</span> <span class="s1">&#39;^&#39;</span> <span class="o">*</span> <span class="n">lb</span></span>
<span class="num"><a href="#78">78</a></span><span class="full not_run">                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span class="full not_run">                    <span class="n">atags</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="n">la</span></span>
<span class="num"><a href="#80">80</a></span><span class="full not_run">                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;insert&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">                    <span class="n">btags</span> <span class="o">+=</span> <span class="s1">&#39;+&#39;</span> <span class="o">*</span> <span class="n">lb</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;equal&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="n">atags</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">la</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="n">btags</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">lb</span></span>
<span class="num"><a href="#85">85</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unknown tag </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,))</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qformat</span><span class="p">(</span><span class="n">aelt</span><span class="p">,</span> <span class="n">belt</span><span class="p">,</span> <span class="n">atags</span><span class="p">,</span> <span class="n">btags</span><span class="p">)</span></span>
<span class="num"><a href="#88">88</a></span><span>        <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span>            <span class="c1"># the synch pair is identical</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">yield</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">aelt</span></span>
<span class="num"><a href="#91">91</a></span><span></span>
<span class="num"><a href="#92">92</a></span><span>        <span class="c1"># pump out diffs from after the synch point</span></span>
<span class="num"><a href="#93">93</a></span><span class="full not_run">        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fancy_helper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">best_i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ahi</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">best_j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">bhi</span><span class="p">)</span></span>
            </pre>
            <p><b>Path 4</b>: 6 calls (0.06)</p>
                <p><button class="input"><span>&#8594;</span> a</button> ['line 0', '1234567890123456789012345689012345', 'line 1', 'line 2', 'line 3', 'line 4   changed', 'line 5   changed', 'line 6   changed', 'line 7', '...</p>
                <p><button class="input"><span>&#8594;</span> alo</button> 3 (3) 9 (3) </p>
                <p><button class="input"><span>&#8594;</span> ahi</button> 4 (3) 10 (3) </p>
                <p><button class="input"><span>&#8594;</span> b</button> ['line 0', '1234567890123456789012345689012345', 'line 1', 'line 2    added', 'line 3', 'line 4   chanGEd', 'line 5a  chanGed', 'line 6a  changEd', 'l...</p>
                <p><button class="input"><span>&#8594;</span> blo</button> 3 (3) 9 (3) </p>
                <p><button class="input"><span>&#8594;</span> bhi</button> 4 (3) 10 (3) </p>
                <p><button class="output"><span>&#8647; yield</span></button> '- line 2' (3) '+ line 2    added' (3) '- line 8  subtracted' (3) '+ line 8' (3) </p>
                <p><button class="output"><span>&#8617; return</span></button> None (6) </p>
            <button class="run" title="lines run...">15 run</button>
            <button class="not_run" title="lines not run...">29 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_fancy_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">alo</span><span class="p">,</span> <span class="n">ahi</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blo</span><span class="p">,</span> <span class="n">bhi</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span></span>
<span class="num"><a href="#3">3</a></span><span><span class="sd">        When replacing one block of lines with another, search the blocks</span></span>
<span class="num"><a href="#4">4</a></span><span><span class="sd">        for *similar* lines; the best-matching pair (if any) is used as a</span></span>
<span class="num"><a href="#5">5</a></span><span><span class="sd">        synch point, and intraline difference marking is done on the</span></span>
<span class="num"><a href="#6">6</a></span><span><span class="sd">        similar pair. Lots of work, but often worth it.</span></span>
<span class="num"><a href="#7">7</a></span><span></span>
<span class="num"><a href="#8">8</a></span><span><span class="sd">        Example:</span></span>
<span class="num"><a href="#9">9</a></span><span></span>
<span class="num"><a href="#10">10</a></span><span><span class="sd">        &gt;&gt;&gt; d = Differ()</span></span>
<span class="num"><a href="#11">11</a></span><span><span class="sd">        &gt;&gt;&gt; results = d._fancy_replace([&#39;abcDefghiJkl\n&#39;], 0, 1,</span></span>
<span class="num"><a href="#12">12</a></span><span><span class="sd">        ...                            [&#39;abcdefGhijkl\n&#39;], 0, 1)</span></span>
<span class="num"><a href="#13">13</a></span><span><span class="sd">        &gt;&gt;&gt; print(&#39;&#39;.join(results), end=&quot;&quot;)</span></span>
<span class="num"><a href="#14">14</a></span><span><span class="sd">        - abcDefghiJkl</span></span>
<span class="num"><a href="#15">15</a></span><span><span class="sd">        ?    ^  ^  ^</span></span>
<span class="num"><a href="#16">16</a></span><span><span class="sd">        + abcdefGhijkl</span></span>
<span class="num"><a href="#17">17</a></span><span><span class="sd">        ?    ^  ^  ^</span></span>
<span class="num"><a href="#18">18</a></span><span><span class="sd">        &quot;&quot;&quot;</span></span>
<span class="num"><a href="#19">19</a></span><span></span>
<span class="num"><a href="#20">20</a></span><span>        <span class="c1"># don&#39;t synch up unless the lines have a similarity score of at</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># least cutoff; best_ratio tracks the best score seen so far</span></span>
<span class="num"><a href="#22">22</a></span><span class="full run">        <span class="n">best_ratio</span><span class="p">,</span> <span class="n">cutoff</span> <span class="o">=</span> <span class="mf">0.74</span><span class="p">,</span> <span class="mf">0.75</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="n">cruncher</span> <span class="o">=</span> <span class="n">SequenceMatcher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charjunk</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span class="full run">        <span class="n">eqi</span><span class="p">,</span> <span class="n">eqj</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>   <span class="c1"># 1st indices of equal lines (if any)</span></span>
<span class="num"><a href="#25">25</a></span><span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># search for the pair that matches best without being identical</span></span>
<span class="num"><a href="#27">27</a></span><span>        <span class="c1"># (identical lines must be junk lines, &amp; we don&#39;t want to synch up</span></span>
<span class="num"><a href="#28">28</a></span><span>        <span class="c1"># on junk -- unless we have to)</span></span>
<span class="num"><a href="#29">29</a></span><span class="full run">        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">blo</span><span class="p">,</span> <span class="n">bhi</span><span class="p">):</span></span>
<span class="num"><a href="#30">30</a></span><span class="full run">            <span class="n">bj</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">]</span></span>
<span class="num"><a href="#31">31</a></span><span class="full run">            <span class="n">cruncher</span><span class="o">.</span><span class="n">set_seq2</span><span class="p">(</span><span class="n">bj</span><span class="p">)</span></span>
<span class="num"><a href="#32">32</a></span><span class="full run">            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">alo</span><span class="p">,</span> <span class="n">ahi</span><span class="p">):</span></span>
<span class="num"><a href="#33">33</a></span><span class="full run">                <span class="n">ai</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></span>
<span class="num"><a href="#34">34</a></span><span class="full run">                <span class="k">if</span> <span class="n">ai</span> <span class="o">==</span> <span class="n">bj</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">eqi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                        <span class="n">eqi</span><span class="p">,</span> <span class="n">eqj</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#38">38</a></span><span class="full run">                <span class="n">cruncher</span><span class="o">.</span><span class="n">set_seq1</span><span class="p">(</span><span class="n">ai</span><span class="p">)</span></span>
<span class="num"><a href="#39">39</a></span><span>                <span class="c1"># computing similarity is expensive, so use the quick</span></span>
<span class="num"><a href="#40">40</a></span><span>                <span class="c1"># upper bounds first -- have seen this speed up messy</span></span>
<span class="num"><a href="#41">41</a></span><span>                <span class="c1"># compares by a factor of 3.</span></span>
<span class="num"><a href="#42">42</a></span><span>                <span class="c1"># note that ratio() is only expensive to compute the first</span></span>
<span class="num"><a href="#43">43</a></span><span>                <span class="c1"># time it&#39;s called on a sequence pair; the expensive part</span></span>
<span class="num"><a href="#44">44</a></span><span>                <span class="c1"># of the computation is cached by cruncher</span></span>
<span class="num"><a href="#45">45</a></span><span class="full run">                <span class="k">if</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">real_quick_ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">best_ratio</span> <span class="ow">and</span> \</span>
<span class="num"><a href="#46">46</a></span><span class="full not_run">                      <span class="n">cruncher</span><span class="o">.</span><span class="n">quick_ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">best_ratio</span> <span class="ow">and</span> \</span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                      <span class="n">cruncher</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">best_ratio</span><span class="p">:</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="n">best_ratio</span><span class="p">,</span> <span class="n">best_i</span><span class="p">,</span> <span class="n">best_j</span> <span class="o">=</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">ratio</span><span class="p">(),</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span></span>
<span class="num"><a href="#49">49</a></span><span class="full run">        <span class="k">if</span> <span class="n">best_ratio</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">:</span></span>
<span class="num"><a href="#50">50</a></span><span>            <span class="c1"># no non-identical &quot;pretty close&quot; pair</span></span>
<span class="num"><a href="#51">51</a></span><span class="full run">            <span class="k">if</span> <span class="n">eqi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#52">52</a></span><span>                <span class="c1"># no identical pair either -- treat it as a straight replace</span></span>
<span class="num"><a href="#53">53</a></span><span class="full run">                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plain_replace</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">alo</span><span class="p">,</span> <span class="n">ahi</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blo</span><span class="p">,</span> <span class="n">bhi</span><span class="p">)</span></span>
<span class="num"><a href="#54">54</a></span><span class="full run">                <span class="k">return</span></span>
<span class="num"><a href="#55">55</a></span><span>            <span class="c1"># no close pair, but an identical pair -- synch up on that</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">            <span class="n">best_i</span><span class="p">,</span> <span class="n">best_j</span><span class="p">,</span> <span class="n">best_ratio</span> <span class="o">=</span> <span class="n">eqi</span><span class="p">,</span> <span class="n">eqj</span><span class="p">,</span> <span class="mf">1.0</span></span>
<span class="num"><a href="#57">57</a></span><span>        <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#58">58</a></span><span>            <span class="c1"># there&#39;s a close pair, so forget the identical pair (if any)</span></span>
<span class="num"><a href="#59">59</a></span><span class="full not_run">            <span class="n">eqi</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#60">60</a></span><span></span>
<span class="num"><a href="#61">61</a></span><span>        <span class="c1"># a[best_i] very similar to b[best_j]; eqi is None iff they&#39;re not</span></span>
<span class="num"><a href="#62">62</a></span><span>        <span class="c1"># identical</span></span>
<span class="num"><a href="#63">63</a></span><span></span>
<span class="num"><a href="#64">64</a></span><span>        <span class="c1"># pump out diffs from before the synch point</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fancy_helper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">alo</span><span class="p">,</span> <span class="n">best_i</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blo</span><span class="p">,</span> <span class="n">best_j</span><span class="p">)</span></span>
<span class="num"><a href="#66">66</a></span><span></span>
<span class="num"><a href="#67">67</a></span><span>        <span class="c1"># do intraline marking on the synch pair</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">        <span class="n">aelt</span><span class="p">,</span> <span class="n">belt</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">best_i</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">best_j</span><span class="p">]</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">        <span class="k">if</span> <span class="n">eqi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span>            <span class="c1"># pump out a &#39;-&#39;, &#39;?&#39;, &#39;+&#39;, &#39;?&#39; quad for the synched lines</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">            <span class="n">atags</span> <span class="o">=</span> <span class="n">btags</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">            <span class="n">cruncher</span><span class="o">.</span><span class="n">set_seqs</span><span class="p">(</span><span class="n">aelt</span><span class="p">,</span> <span class="n">belt</span><span class="p">)</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">ai1</span><span class="p">,</span> <span class="n">ai2</span><span class="p">,</span> <span class="n">bj1</span><span class="p">,</span> <span class="n">bj2</span> <span class="ow">in</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">get_opcodes</span><span class="p">():</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                <span class="n">la</span><span class="p">,</span> <span class="n">lb</span> <span class="o">=</span> <span class="n">ai2</span> <span class="o">-</span> <span class="n">ai1</span><span class="p">,</span> <span class="n">bj2</span> <span class="o">-</span> <span class="n">bj1</span></span>
<span class="num"><a href="#75">75</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;replace&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                    <span class="n">atags</span> <span class="o">+=</span> <span class="s1">&#39;^&#39;</span> <span class="o">*</span> <span class="n">la</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">                    <span class="n">btags</span> <span class="o">+=</span> <span class="s1">&#39;^&#39;</span> <span class="o">*</span> <span class="n">lb</span></span>
<span class="num"><a href="#78">78</a></span><span class="full not_run">                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span class="full not_run">                    <span class="n">atags</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="n">la</span></span>
<span class="num"><a href="#80">80</a></span><span class="full not_run">                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;insert&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">                    <span class="n">btags</span> <span class="o">+=</span> <span class="s1">&#39;+&#39;</span> <span class="o">*</span> <span class="n">lb</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;equal&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="n">atags</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">la</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="n">btags</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">lb</span></span>
<span class="num"><a href="#85">85</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unknown tag </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,))</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qformat</span><span class="p">(</span><span class="n">aelt</span><span class="p">,</span> <span class="n">belt</span><span class="p">,</span> <span class="n">atags</span><span class="p">,</span> <span class="n">btags</span><span class="p">)</span></span>
<span class="num"><a href="#88">88</a></span><span>        <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span>            <span class="c1"># the synch pair is identical</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">yield</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">aelt</span></span>
<span class="num"><a href="#91">91</a></span><span></span>
<span class="num"><a href="#92">92</a></span><span>        <span class="c1"># pump out diffs from after the synch point</span></span>
<span class="num"><a href="#93">93</a></span><span class="full not_run">        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fancy_helper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">best_i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ahi</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">best_j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">bhi</span><span class="p">)</span></span>
            </pre>
            <p><b>Path 5</b>: 5 calls (0.05)</p>
                <p><button class="input"><span>&#8594;</span> a</button> ['one\n', 'two\n', 'three\n'] (3) ['', '\t\t\t\tLine 1: preceded by from:[tt] to:[ssss]', '  \t\t\t\tLine 2: preceded by from:[sstt] to:[sssst]', '  \...</p>
                <p><button class="input"><span>&#8594;</span> alo</button> 0 (3) 1 (2) </p>
                <p><button class="input"><span>&#8594;</span> ahi</button> 3 (3) 6 (2) </p>
                <p><button class="input"><span>&#8594;</span> b</button> ['ore\n', 'tree\n', 'emu\n'] (3) ['', '    Line 1: preceded by from:[tt] to:[ssss]', '    \t\tLine 2: preceded by from:[sstt] to:[sssst]', '      Line...</p>
                <p><button class="input"><span>&#8594;</span> blo</button> 0 (3) 1 (2) </p>
                <p><button class="input"><span>&#8594;</span> bhi</button> 3 (3) 6 (2) </p>
                <p><button class="output"><span>&#8647; yield</span></button> '?  ^\n' (6) None (5) '? ^^^^\n' (3) '?   ^^\n' (3) '?   ^^^^\n' (3) '?          ^\n' (3) '- one\n' (3) '+ ore\n' (3) '- two\n' (3) '- three\n' (3) </p>
            <button class="run" title="lines run...">32 run</button>
            <button class="not_run" title="lines not run...">12 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_fancy_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">alo</span><span class="p">,</span> <span class="n">ahi</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blo</span><span class="p">,</span> <span class="n">bhi</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span></span>
<span class="num"><a href="#3">3</a></span><span><span class="sd">        When replacing one block of lines with another, search the blocks</span></span>
<span class="num"><a href="#4">4</a></span><span><span class="sd">        for *similar* lines; the best-matching pair (if any) is used as a</span></span>
<span class="num"><a href="#5">5</a></span><span><span class="sd">        synch point, and intraline difference marking is done on the</span></span>
<span class="num"><a href="#6">6</a></span><span><span class="sd">        similar pair. Lots of work, but often worth it.</span></span>
<span class="num"><a href="#7">7</a></span><span></span>
<span class="num"><a href="#8">8</a></span><span><span class="sd">        Example:</span></span>
<span class="num"><a href="#9">9</a></span><span></span>
<span class="num"><a href="#10">10</a></span><span><span class="sd">        &gt;&gt;&gt; d = Differ()</span></span>
<span class="num"><a href="#11">11</a></span><span><span class="sd">        &gt;&gt;&gt; results = d._fancy_replace([&#39;abcDefghiJkl\n&#39;], 0, 1,</span></span>
<span class="num"><a href="#12">12</a></span><span><span class="sd">        ...                            [&#39;abcdefGhijkl\n&#39;], 0, 1)</span></span>
<span class="num"><a href="#13">13</a></span><span><span class="sd">        &gt;&gt;&gt; print(&#39;&#39;.join(results), end=&quot;&quot;)</span></span>
<span class="num"><a href="#14">14</a></span><span><span class="sd">        - abcDefghiJkl</span></span>
<span class="num"><a href="#15">15</a></span><span><span class="sd">        ?    ^  ^  ^</span></span>
<span class="num"><a href="#16">16</a></span><span><span class="sd">        + abcdefGhijkl</span></span>
<span class="num"><a href="#17">17</a></span><span><span class="sd">        ?    ^  ^  ^</span></span>
<span class="num"><a href="#18">18</a></span><span><span class="sd">        &quot;&quot;&quot;</span></span>
<span class="num"><a href="#19">19</a></span><span></span>
<span class="num"><a href="#20">20</a></span><span>        <span class="c1"># don&#39;t synch up unless the lines have a similarity score of at</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># least cutoff; best_ratio tracks the best score seen so far</span></span>
<span class="num"><a href="#22">22</a></span><span class="full run">        <span class="n">best_ratio</span><span class="p">,</span> <span class="n">cutoff</span> <span class="o">=</span> <span class="mf">0.74</span><span class="p">,</span> <span class="mf">0.75</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="n">cruncher</span> <span class="o">=</span> <span class="n">SequenceMatcher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charjunk</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span class="full run">        <span class="n">eqi</span><span class="p">,</span> <span class="n">eqj</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>   <span class="c1"># 1st indices of equal lines (if any)</span></span>
<span class="num"><a href="#25">25</a></span><span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># search for the pair that matches best without being identical</span></span>
<span class="num"><a href="#27">27</a></span><span>        <span class="c1"># (identical lines must be junk lines, &amp; we don&#39;t want to synch up</span></span>
<span class="num"><a href="#28">28</a></span><span>        <span class="c1"># on junk -- unless we have to)</span></span>
<span class="num"><a href="#29">29</a></span><span class="full run">        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">blo</span><span class="p">,</span> <span class="n">bhi</span><span class="p">):</span></span>
<span class="num"><a href="#30">30</a></span><span class="full run">            <span class="n">bj</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">]</span></span>
<span class="num"><a href="#31">31</a></span><span class="full run">            <span class="n">cruncher</span><span class="o">.</span><span class="n">set_seq2</span><span class="p">(</span><span class="n">bj</span><span class="p">)</span></span>
<span class="num"><a href="#32">32</a></span><span class="full run">            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">alo</span><span class="p">,</span> <span class="n">ahi</span><span class="p">):</span></span>
<span class="num"><a href="#33">33</a></span><span class="full run">                <span class="n">ai</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></span>
<span class="num"><a href="#34">34</a></span><span class="full run">                <span class="k">if</span> <span class="n">ai</span> <span class="o">==</span> <span class="n">bj</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">eqi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                        <span class="n">eqi</span><span class="p">,</span> <span class="n">eqj</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#38">38</a></span><span class="full run">                <span class="n">cruncher</span><span class="o">.</span><span class="n">set_seq1</span><span class="p">(</span><span class="n">ai</span><span class="p">)</span></span>
<span class="num"><a href="#39">39</a></span><span>                <span class="c1"># computing similarity is expensive, so use the quick</span></span>
<span class="num"><a href="#40">40</a></span><span>                <span class="c1"># upper bounds first -- have seen this speed up messy</span></span>
<span class="num"><a href="#41">41</a></span><span>                <span class="c1"># compares by a factor of 3.</span></span>
<span class="num"><a href="#42">42</a></span><span>                <span class="c1"># note that ratio() is only expensive to compute the first</span></span>
<span class="num"><a href="#43">43</a></span><span>                <span class="c1"># time it&#39;s called on a sequence pair; the expensive part</span></span>
<span class="num"><a href="#44">44</a></span><span>                <span class="c1"># of the computation is cached by cruncher</span></span>
<span class="num"><a href="#45">45</a></span><span class="full run">                <span class="k">if</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">real_quick_ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">best_ratio</span> <span class="ow">and</span> \</span>
<span class="num"><a href="#46">46</a></span><span class="full run">                      <span class="n">cruncher</span><span class="o">.</span><span class="n">quick_ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">best_ratio</span> <span class="ow">and</span> \</span>
<span class="num"><a href="#47">47</a></span><span class="full run">                      <span class="n">cruncher</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">best_ratio</span><span class="p">:</span></span>
<span class="num"><a href="#48">48</a></span><span class="full run">                    <span class="n">best_ratio</span><span class="p">,</span> <span class="n">best_i</span><span class="p">,</span> <span class="n">best_j</span> <span class="o">=</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">ratio</span><span class="p">(),</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span></span>
<span class="num"><a href="#49">49</a></span><span class="full run">        <span class="k">if</span> <span class="n">best_ratio</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">:</span></span>
<span class="num"><a href="#50">50</a></span><span>            <span class="c1"># no non-identical &quot;pretty close&quot; pair</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">eqi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#52">52</a></span><span>                <span class="c1"># no identical pair either -- treat it as a straight replace</span></span>
<span class="num"><a href="#53">53</a></span><span class="full not_run">                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plain_replace</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">alo</span><span class="p">,</span> <span class="n">ahi</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blo</span><span class="p">,</span> <span class="n">bhi</span><span class="p">)</span></span>
<span class="num"><a href="#54">54</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#55">55</a></span><span>            <span class="c1"># no close pair, but an identical pair -- synch up on that</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">            <span class="n">best_i</span><span class="p">,</span> <span class="n">best_j</span><span class="p">,</span> <span class="n">best_ratio</span> <span class="o">=</span> <span class="n">eqi</span><span class="p">,</span> <span class="n">eqj</span><span class="p">,</span> <span class="mf">1.0</span></span>
<span class="num"><a href="#57">57</a></span><span>        <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#58">58</a></span><span>            <span class="c1"># there&#39;s a close pair, so forget the identical pair (if any)</span></span>
<span class="num"><a href="#59">59</a></span><span class="full run">            <span class="n">eqi</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#60">60</a></span><span></span>
<span class="num"><a href="#61">61</a></span><span>        <span class="c1"># a[best_i] very similar to b[best_j]; eqi is None iff they&#39;re not</span></span>
<span class="num"><a href="#62">62</a></span><span>        <span class="c1"># identical</span></span>
<span class="num"><a href="#63">63</a></span><span></span>
<span class="num"><a href="#64">64</a></span><span>        <span class="c1"># pump out diffs from before the synch point</span></span>
<span class="num"><a href="#65">65</a></span><span class="full run">        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fancy_helper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">alo</span><span class="p">,</span> <span class="n">best_i</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blo</span><span class="p">,</span> <span class="n">best_j</span><span class="p">)</span></span>
<span class="num"><a href="#66">66</a></span><span></span>
<span class="num"><a href="#67">67</a></span><span>        <span class="c1"># do intraline marking on the synch pair</span></span>
<span class="num"><a href="#68">68</a></span><span class="full run">        <span class="n">aelt</span><span class="p">,</span> <span class="n">belt</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">best_i</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">best_j</span><span class="p">]</span></span>
<span class="num"><a href="#69">69</a></span><span class="full run">        <span class="k">if</span> <span class="n">eqi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span>            <span class="c1"># pump out a &#39;-&#39;, &#39;?&#39;, &#39;+&#39;, &#39;?&#39; quad for the synched lines</span></span>
<span class="num"><a href="#71">71</a></span><span class="full run">            <span class="n">atags</span> <span class="o">=</span> <span class="n">btags</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span></span>
<span class="num"><a href="#72">72</a></span><span class="full run">            <span class="n">cruncher</span><span class="o">.</span><span class="n">set_seqs</span><span class="p">(</span><span class="n">aelt</span><span class="p">,</span> <span class="n">belt</span><span class="p">)</span></span>
<span class="num"><a href="#73">73</a></span><span class="full run">            <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">ai1</span><span class="p">,</span> <span class="n">ai2</span><span class="p">,</span> <span class="n">bj1</span><span class="p">,</span> <span class="n">bj2</span> <span class="ow">in</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">get_opcodes</span><span class="p">():</span></span>
<span class="num"><a href="#74">74</a></span><span class="full run">                <span class="n">la</span><span class="p">,</span> <span class="n">lb</span> <span class="o">=</span> <span class="n">ai2</span> <span class="o">-</span> <span class="n">ai1</span><span class="p">,</span> <span class="n">bj2</span> <span class="o">-</span> <span class="n">bj1</span></span>
<span class="num"><a href="#75">75</a></span><span class="full run">                <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;replace&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                    <span class="n">atags</span> <span class="o">+=</span> <span class="s1">&#39;^&#39;</span> <span class="o">*</span> <span class="n">la</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">                    <span class="n">btags</span> <span class="o">+=</span> <span class="s1">&#39;^&#39;</span> <span class="o">*</span> <span class="n">lb</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span class="full run">                    <span class="n">atags</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="n">la</span></span>
<span class="num"><a href="#80">80</a></span><span class="full run">                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;insert&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">                    <span class="n">btags</span> <span class="o">+=</span> <span class="s1">&#39;+&#39;</span> <span class="o">*</span> <span class="n">lb</span></span>
<span class="num"><a href="#82">82</a></span><span class="full run">                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;equal&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full run">                    <span class="n">atags</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">la</span></span>
<span class="num"><a href="#84">84</a></span><span class="full run">                    <span class="n">btags</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">lb</span></span>
<span class="num"><a href="#85">85</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unknown tag </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,))</span></span>
<span class="num"><a href="#87">87</a></span><span class="full run">            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qformat</span><span class="p">(</span><span class="n">aelt</span><span class="p">,</span> <span class="n">belt</span><span class="p">,</span> <span class="n">atags</span><span class="p">,</span> <span class="n">btags</span><span class="p">)</span></span>
<span class="num"><a href="#88">88</a></span><span>        <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span>            <span class="c1"># the synch pair is identical</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">yield</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">aelt</span></span>
<span class="num"><a href="#91">91</a></span><span></span>
<span class="num"><a href="#92">92</a></span><span>        <span class="c1"># pump out diffs from after the synch point</span></span>
<span class="num"><a href="#93">93</a></span><span class="full run">        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fancy_helper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">best_i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ahi</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">best_j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">bhi</span><span class="p">)</span></span>
            </pre>
            <p><b>Path 6</b>: 4 calls (0.04)</p>
                <p><button class="input"><span>&#8594;</span> a</button> ['line 0', '1234567890123456789012345689012345', 'line 1', 'line 2', 'line 3', 'line 4   changed', 'line 5   changed', 'line 6   changed', 'line 7', '...</p>
                <p><button class="input"><span>&#8594;</span> alo</button> 11 (3) 0 (1) </p>
                <p><button class="input"><span>&#8594;</span> ahi</button> 13 (3) 1 (1) </p>
                <p><button class="input"><span>&#8594;</span> b</button> ['line 0', '1234567890123456789012345689012345', 'line 1', 'line 2    added', 'line 3', 'line 4   chanGEd', 'line 5a  chanGed', 'line 6a  changEd', 'l...</p>
                <p><button class="input"><span>&#8594;</span> blo</button> 11 (3) 0 (1) </p>
                <p><button class="input"><span>&#8594;</span> bhi</button> 13 (3) 1 (1) </p>
                <p><button class="output"><span>&#8647; yield</span></button> '- 1234567890123456789012345689012345' (3) '- short line' (3) '+ 1234567890' (3) '+ another long line that needs to be wrapped' (3) '- 2' (1) '+ 3' (1...</p>
                <p><button class="output"><span>&#8617; return</span></button> None (4) </p>
            <button class="run" title="lines run...">16 run</button>
            <button class="not_run" title="lines not run...">28 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_fancy_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">alo</span><span class="p">,</span> <span class="n">ahi</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blo</span><span class="p">,</span> <span class="n">bhi</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span></span>
<span class="num"><a href="#3">3</a></span><span><span class="sd">        When replacing one block of lines with another, search the blocks</span></span>
<span class="num"><a href="#4">4</a></span><span><span class="sd">        for *similar* lines; the best-matching pair (if any) is used as a</span></span>
<span class="num"><a href="#5">5</a></span><span><span class="sd">        synch point, and intraline difference marking is done on the</span></span>
<span class="num"><a href="#6">6</a></span><span><span class="sd">        similar pair. Lots of work, but often worth it.</span></span>
<span class="num"><a href="#7">7</a></span><span></span>
<span class="num"><a href="#8">8</a></span><span><span class="sd">        Example:</span></span>
<span class="num"><a href="#9">9</a></span><span></span>
<span class="num"><a href="#10">10</a></span><span><span class="sd">        &gt;&gt;&gt; d = Differ()</span></span>
<span class="num"><a href="#11">11</a></span><span><span class="sd">        &gt;&gt;&gt; results = d._fancy_replace([&#39;abcDefghiJkl\n&#39;], 0, 1,</span></span>
<span class="num"><a href="#12">12</a></span><span><span class="sd">        ...                            [&#39;abcdefGhijkl\n&#39;], 0, 1)</span></span>
<span class="num"><a href="#13">13</a></span><span><span class="sd">        &gt;&gt;&gt; print(&#39;&#39;.join(results), end=&quot;&quot;)</span></span>
<span class="num"><a href="#14">14</a></span><span><span class="sd">        - abcDefghiJkl</span></span>
<span class="num"><a href="#15">15</a></span><span><span class="sd">        ?    ^  ^  ^</span></span>
<span class="num"><a href="#16">16</a></span><span><span class="sd">        + abcdefGhijkl</span></span>
<span class="num"><a href="#17">17</a></span><span><span class="sd">        ?    ^  ^  ^</span></span>
<span class="num"><a href="#18">18</a></span><span><span class="sd">        &quot;&quot;&quot;</span></span>
<span class="num"><a href="#19">19</a></span><span></span>
<span class="num"><a href="#20">20</a></span><span>        <span class="c1"># don&#39;t synch up unless the lines have a similarity score of at</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># least cutoff; best_ratio tracks the best score seen so far</span></span>
<span class="num"><a href="#22">22</a></span><span class="full run">        <span class="n">best_ratio</span><span class="p">,</span> <span class="n">cutoff</span> <span class="o">=</span> <span class="mf">0.74</span><span class="p">,</span> <span class="mf">0.75</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="n">cruncher</span> <span class="o">=</span> <span class="n">SequenceMatcher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charjunk</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span class="full run">        <span class="n">eqi</span><span class="p">,</span> <span class="n">eqj</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>   <span class="c1"># 1st indices of equal lines (if any)</span></span>
<span class="num"><a href="#25">25</a></span><span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># search for the pair that matches best without being identical</span></span>
<span class="num"><a href="#27">27</a></span><span>        <span class="c1"># (identical lines must be junk lines, &amp; we don&#39;t want to synch up</span></span>
<span class="num"><a href="#28">28</a></span><span>        <span class="c1"># on junk -- unless we have to)</span></span>
<span class="num"><a href="#29">29</a></span><span class="full run">        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">blo</span><span class="p">,</span> <span class="n">bhi</span><span class="p">):</span></span>
<span class="num"><a href="#30">30</a></span><span class="full run">            <span class="n">bj</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">]</span></span>
<span class="num"><a href="#31">31</a></span><span class="full run">            <span class="n">cruncher</span><span class="o">.</span><span class="n">set_seq2</span><span class="p">(</span><span class="n">bj</span><span class="p">)</span></span>
<span class="num"><a href="#32">32</a></span><span class="full run">            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">alo</span><span class="p">,</span> <span class="n">ahi</span><span class="p">):</span></span>
<span class="num"><a href="#33">33</a></span><span class="full run">                <span class="n">ai</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></span>
<span class="num"><a href="#34">34</a></span><span class="full run">                <span class="k">if</span> <span class="n">ai</span> <span class="o">==</span> <span class="n">bj</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">eqi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                        <span class="n">eqi</span><span class="p">,</span> <span class="n">eqj</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#38">38</a></span><span class="full run">                <span class="n">cruncher</span><span class="o">.</span><span class="n">set_seq1</span><span class="p">(</span><span class="n">ai</span><span class="p">)</span></span>
<span class="num"><a href="#39">39</a></span><span>                <span class="c1"># computing similarity is expensive, so use the quick</span></span>
<span class="num"><a href="#40">40</a></span><span>                <span class="c1"># upper bounds first -- have seen this speed up messy</span></span>
<span class="num"><a href="#41">41</a></span><span>                <span class="c1"># compares by a factor of 3.</span></span>
<span class="num"><a href="#42">42</a></span><span>                <span class="c1"># note that ratio() is only expensive to compute the first</span></span>
<span class="num"><a href="#43">43</a></span><span>                <span class="c1"># time it&#39;s called on a sequence pair; the expensive part</span></span>
<span class="num"><a href="#44">44</a></span><span>                <span class="c1"># of the computation is cached by cruncher</span></span>
<span class="num"><a href="#45">45</a></span><span class="full run">                <span class="k">if</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">real_quick_ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">best_ratio</span> <span class="ow">and</span> \</span>
<span class="num"><a href="#46">46</a></span><span class="full run">                      <span class="n">cruncher</span><span class="o">.</span><span class="n">quick_ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">best_ratio</span> <span class="ow">and</span> \</span>
<span class="num"><a href="#47">47</a></span><span class="full not_run">                      <span class="n">cruncher</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">best_ratio</span><span class="p">:</span></span>
<span class="num"><a href="#48">48</a></span><span class="full not_run">                    <span class="n">best_ratio</span><span class="p">,</span> <span class="n">best_i</span><span class="p">,</span> <span class="n">best_j</span> <span class="o">=</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">ratio</span><span class="p">(),</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span></span>
<span class="num"><a href="#49">49</a></span><span class="full run">        <span class="k">if</span> <span class="n">best_ratio</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">:</span></span>
<span class="num"><a href="#50">50</a></span><span>            <span class="c1"># no non-identical &quot;pretty close&quot; pair</span></span>
<span class="num"><a href="#51">51</a></span><span class="full run">            <span class="k">if</span> <span class="n">eqi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#52">52</a></span><span>                <span class="c1"># no identical pair either -- treat it as a straight replace</span></span>
<span class="num"><a href="#53">53</a></span><span class="full run">                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plain_replace</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">alo</span><span class="p">,</span> <span class="n">ahi</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blo</span><span class="p">,</span> <span class="n">bhi</span><span class="p">)</span></span>
<span class="num"><a href="#54">54</a></span><span class="full run">                <span class="k">return</span></span>
<span class="num"><a href="#55">55</a></span><span>            <span class="c1"># no close pair, but an identical pair -- synch up on that</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">            <span class="n">best_i</span><span class="p">,</span> <span class="n">best_j</span><span class="p">,</span> <span class="n">best_ratio</span> <span class="o">=</span> <span class="n">eqi</span><span class="p">,</span> <span class="n">eqj</span><span class="p">,</span> <span class="mf">1.0</span></span>
<span class="num"><a href="#57">57</a></span><span>        <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#58">58</a></span><span>            <span class="c1"># there&#39;s a close pair, so forget the identical pair (if any)</span></span>
<span class="num"><a href="#59">59</a></span><span class="full not_run">            <span class="n">eqi</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#60">60</a></span><span></span>
<span class="num"><a href="#61">61</a></span><span>        <span class="c1"># a[best_i] very similar to b[best_j]; eqi is None iff they&#39;re not</span></span>
<span class="num"><a href="#62">62</a></span><span>        <span class="c1"># identical</span></span>
<span class="num"><a href="#63">63</a></span><span></span>
<span class="num"><a href="#64">64</a></span><span>        <span class="c1"># pump out diffs from before the synch point</span></span>
<span class="num"><a href="#65">65</a></span><span class="full not_run">        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fancy_helper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">alo</span><span class="p">,</span> <span class="n">best_i</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blo</span><span class="p">,</span> <span class="n">best_j</span><span class="p">)</span></span>
<span class="num"><a href="#66">66</a></span><span></span>
<span class="num"><a href="#67">67</a></span><span>        <span class="c1"># do intraline marking on the synch pair</span></span>
<span class="num"><a href="#68">68</a></span><span class="full not_run">        <span class="n">aelt</span><span class="p">,</span> <span class="n">belt</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">best_i</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">best_j</span><span class="p">]</span></span>
<span class="num"><a href="#69">69</a></span><span class="full not_run">        <span class="k">if</span> <span class="n">eqi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span>            <span class="c1"># pump out a &#39;-&#39;, &#39;?&#39;, &#39;+&#39;, &#39;?&#39; quad for the synched lines</span></span>
<span class="num"><a href="#71">71</a></span><span class="full not_run">            <span class="n">atags</span> <span class="o">=</span> <span class="n">btags</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span></span>
<span class="num"><a href="#72">72</a></span><span class="full not_run">            <span class="n">cruncher</span><span class="o">.</span><span class="n">set_seqs</span><span class="p">(</span><span class="n">aelt</span><span class="p">,</span> <span class="n">belt</span><span class="p">)</span></span>
<span class="num"><a href="#73">73</a></span><span class="full not_run">            <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">ai1</span><span class="p">,</span> <span class="n">ai2</span><span class="p">,</span> <span class="n">bj1</span><span class="p">,</span> <span class="n">bj2</span> <span class="ow">in</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">get_opcodes</span><span class="p">():</span></span>
<span class="num"><a href="#74">74</a></span><span class="full not_run">                <span class="n">la</span><span class="p">,</span> <span class="n">lb</span> <span class="o">=</span> <span class="n">ai2</span> <span class="o">-</span> <span class="n">ai1</span><span class="p">,</span> <span class="n">bj2</span> <span class="o">-</span> <span class="n">bj1</span></span>
<span class="num"><a href="#75">75</a></span><span class="full not_run">                <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;replace&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                    <span class="n">atags</span> <span class="o">+=</span> <span class="s1">&#39;^&#39;</span> <span class="o">*</span> <span class="n">la</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">                    <span class="n">btags</span> <span class="o">+=</span> <span class="s1">&#39;^&#39;</span> <span class="o">*</span> <span class="n">lb</span></span>
<span class="num"><a href="#78">78</a></span><span class="full not_run">                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span class="full not_run">                    <span class="n">atags</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="n">la</span></span>
<span class="num"><a href="#80">80</a></span><span class="full not_run">                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;insert&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#81">81</a></span><span class="full not_run">                    <span class="n">btags</span> <span class="o">+=</span> <span class="s1">&#39;+&#39;</span> <span class="o">*</span> <span class="n">lb</span></span>
<span class="num"><a href="#82">82</a></span><span class="full not_run">                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;equal&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full not_run">                    <span class="n">atags</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">la</span></span>
<span class="num"><a href="#84">84</a></span><span class="full not_run">                    <span class="n">btags</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">lb</span></span>
<span class="num"><a href="#85">85</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unknown tag </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,))</span></span>
<span class="num"><a href="#87">87</a></span><span class="full not_run">            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qformat</span><span class="p">(</span><span class="n">aelt</span><span class="p">,</span> <span class="n">belt</span><span class="p">,</span> <span class="n">atags</span><span class="p">,</span> <span class="n">btags</span><span class="p">)</span></span>
<span class="num"><a href="#88">88</a></span><span>        <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span>            <span class="c1"># the synch pair is identical</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">yield</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">aelt</span></span>
<span class="num"><a href="#91">91</a></span><span></span>
<span class="num"><a href="#92">92</a></span><span>        <span class="c1"># pump out diffs from after the synch point</span></span>
<span class="num"><a href="#93">93</a></span><span class="full not_run">        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fancy_helper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">best_i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ahi</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">best_j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">bhi</span><span class="p">)</span></span>
            </pre>
            <p><b>Path 7</b>: 1 calls (0.01)</p>
                <p><button class="input"><span>&#8594;</span> a</button> ['\tI am a buggy'] (1) </p>
                <p><button class="input"><span>&#8594;</span> alo</button> 0 (1) </p>
                <p><button class="input"><span>&#8594;</span> ahi</button> 1 (1) </p>
                <p><button class="input"><span>&#8594;</span> b</button> ['\t\tI am a bug'] (1) </p>
                <p><button class="input"><span>&#8594;</span> blo</button> 0 (1) </p>
                <p><button class="input"><span>&#8594;</span> bhi</button> 1 (1) </p>
                <p><button class="output"><span>&#8647; yield</span></button> '- \tI am a buggy' (1) '? \t          --\n' (1) '+ \t\tI am a bug' (1) '? +\n' (1) None (1) </p>
            <button class="run" title="lines run...">33 run</button>
            <button class="not_run" title="lines not run...">11 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_fancy_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">alo</span><span class="p">,</span> <span class="n">ahi</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blo</span><span class="p">,</span> <span class="n">bhi</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span></span>
<span class="num"><a href="#3">3</a></span><span><span class="sd">        When replacing one block of lines with another, search the blocks</span></span>
<span class="num"><a href="#4">4</a></span><span><span class="sd">        for *similar* lines; the best-matching pair (if any) is used as a</span></span>
<span class="num"><a href="#5">5</a></span><span><span class="sd">        synch point, and intraline difference marking is done on the</span></span>
<span class="num"><a href="#6">6</a></span><span><span class="sd">        similar pair. Lots of work, but often worth it.</span></span>
<span class="num"><a href="#7">7</a></span><span></span>
<span class="num"><a href="#8">8</a></span><span><span class="sd">        Example:</span></span>
<span class="num"><a href="#9">9</a></span><span></span>
<span class="num"><a href="#10">10</a></span><span><span class="sd">        &gt;&gt;&gt; d = Differ()</span></span>
<span class="num"><a href="#11">11</a></span><span><span class="sd">        &gt;&gt;&gt; results = d._fancy_replace([&#39;abcDefghiJkl\n&#39;], 0, 1,</span></span>
<span class="num"><a href="#12">12</a></span><span><span class="sd">        ...                            [&#39;abcdefGhijkl\n&#39;], 0, 1)</span></span>
<span class="num"><a href="#13">13</a></span><span><span class="sd">        &gt;&gt;&gt; print(&#39;&#39;.join(results), end=&quot;&quot;)</span></span>
<span class="num"><a href="#14">14</a></span><span><span class="sd">        - abcDefghiJkl</span></span>
<span class="num"><a href="#15">15</a></span><span><span class="sd">        ?    ^  ^  ^</span></span>
<span class="num"><a href="#16">16</a></span><span><span class="sd">        + abcdefGhijkl</span></span>
<span class="num"><a href="#17">17</a></span><span><span class="sd">        ?    ^  ^  ^</span></span>
<span class="num"><a href="#18">18</a></span><span><span class="sd">        &quot;&quot;&quot;</span></span>
<span class="num"><a href="#19">19</a></span><span></span>
<span class="num"><a href="#20">20</a></span><span>        <span class="c1"># don&#39;t synch up unless the lines have a similarity score of at</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># least cutoff; best_ratio tracks the best score seen so far</span></span>
<span class="num"><a href="#22">22</a></span><span class="full run">        <span class="n">best_ratio</span><span class="p">,</span> <span class="n">cutoff</span> <span class="o">=</span> <span class="mf">0.74</span><span class="p">,</span> <span class="mf">0.75</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="n">cruncher</span> <span class="o">=</span> <span class="n">SequenceMatcher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charjunk</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span class="full run">        <span class="n">eqi</span><span class="p">,</span> <span class="n">eqj</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>   <span class="c1"># 1st indices of equal lines (if any)</span></span>
<span class="num"><a href="#25">25</a></span><span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># search for the pair that matches best without being identical</span></span>
<span class="num"><a href="#27">27</a></span><span>        <span class="c1"># (identical lines must be junk lines, &amp; we don&#39;t want to synch up</span></span>
<span class="num"><a href="#28">28</a></span><span>        <span class="c1"># on junk -- unless we have to)</span></span>
<span class="num"><a href="#29">29</a></span><span class="full run">        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">blo</span><span class="p">,</span> <span class="n">bhi</span><span class="p">):</span></span>
<span class="num"><a href="#30">30</a></span><span class="full run">            <span class="n">bj</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">]</span></span>
<span class="num"><a href="#31">31</a></span><span class="full run">            <span class="n">cruncher</span><span class="o">.</span><span class="n">set_seq2</span><span class="p">(</span><span class="n">bj</span><span class="p">)</span></span>
<span class="num"><a href="#32">32</a></span><span class="full run">            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">alo</span><span class="p">,</span> <span class="n">ahi</span><span class="p">):</span></span>
<span class="num"><a href="#33">33</a></span><span class="full run">                <span class="n">ai</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></span>
<span class="num"><a href="#34">34</a></span><span class="full run">                <span class="k">if</span> <span class="n">ai</span> <span class="o">==</span> <span class="n">bj</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">eqi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                        <span class="n">eqi</span><span class="p">,</span> <span class="n">eqj</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#38">38</a></span><span class="full run">                <span class="n">cruncher</span><span class="o">.</span><span class="n">set_seq1</span><span class="p">(</span><span class="n">ai</span><span class="p">)</span></span>
<span class="num"><a href="#39">39</a></span><span>                <span class="c1"># computing similarity is expensive, so use the quick</span></span>
<span class="num"><a href="#40">40</a></span><span>                <span class="c1"># upper bounds first -- have seen this speed up messy</span></span>
<span class="num"><a href="#41">41</a></span><span>                <span class="c1"># compares by a factor of 3.</span></span>
<span class="num"><a href="#42">42</a></span><span>                <span class="c1"># note that ratio() is only expensive to compute the first</span></span>
<span class="num"><a href="#43">43</a></span><span>                <span class="c1"># time it&#39;s called on a sequence pair; the expensive part</span></span>
<span class="num"><a href="#44">44</a></span><span>                <span class="c1"># of the computation is cached by cruncher</span></span>
<span class="num"><a href="#45">45</a></span><span class="full run">                <span class="k">if</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">real_quick_ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">best_ratio</span> <span class="ow">and</span> \</span>
<span class="num"><a href="#46">46</a></span><span class="full run">                      <span class="n">cruncher</span><span class="o">.</span><span class="n">quick_ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">best_ratio</span> <span class="ow">and</span> \</span>
<span class="num"><a href="#47">47</a></span><span class="full run">                      <span class="n">cruncher</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">best_ratio</span><span class="p">:</span></span>
<span class="num"><a href="#48">48</a></span><span class="full run">                    <span class="n">best_ratio</span><span class="p">,</span> <span class="n">best_i</span><span class="p">,</span> <span class="n">best_j</span> <span class="o">=</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">ratio</span><span class="p">(),</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span></span>
<span class="num"><a href="#49">49</a></span><span class="full run">        <span class="k">if</span> <span class="n">best_ratio</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">:</span></span>
<span class="num"><a href="#50">50</a></span><span>            <span class="c1"># no non-identical &quot;pretty close&quot; pair</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">eqi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#52">52</a></span><span>                <span class="c1"># no identical pair either -- treat it as a straight replace</span></span>
<span class="num"><a href="#53">53</a></span><span class="full not_run">                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plain_replace</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">alo</span><span class="p">,</span> <span class="n">ahi</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blo</span><span class="p">,</span> <span class="n">bhi</span><span class="p">)</span></span>
<span class="num"><a href="#54">54</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#55">55</a></span><span>            <span class="c1"># no close pair, but an identical pair -- synch up on that</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">            <span class="n">best_i</span><span class="p">,</span> <span class="n">best_j</span><span class="p">,</span> <span class="n">best_ratio</span> <span class="o">=</span> <span class="n">eqi</span><span class="p">,</span> <span class="n">eqj</span><span class="p">,</span> <span class="mf">1.0</span></span>
<span class="num"><a href="#57">57</a></span><span>        <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#58">58</a></span><span>            <span class="c1"># there&#39;s a close pair, so forget the identical pair (if any)</span></span>
<span class="num"><a href="#59">59</a></span><span class="full run">            <span class="n">eqi</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#60">60</a></span><span></span>
<span class="num"><a href="#61">61</a></span><span>        <span class="c1"># a[best_i] very similar to b[best_j]; eqi is None iff they&#39;re not</span></span>
<span class="num"><a href="#62">62</a></span><span>        <span class="c1"># identical</span></span>
<span class="num"><a href="#63">63</a></span><span></span>
<span class="num"><a href="#64">64</a></span><span>        <span class="c1"># pump out diffs from before the synch point</span></span>
<span class="num"><a href="#65">65</a></span><span class="full run">        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fancy_helper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">alo</span><span class="p">,</span> <span class="n">best_i</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blo</span><span class="p">,</span> <span class="n">best_j</span><span class="p">)</span></span>
<span class="num"><a href="#66">66</a></span><span></span>
<span class="num"><a href="#67">67</a></span><span>        <span class="c1"># do intraline marking on the synch pair</span></span>
<span class="num"><a href="#68">68</a></span><span class="full run">        <span class="n">aelt</span><span class="p">,</span> <span class="n">belt</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">best_i</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">best_j</span><span class="p">]</span></span>
<span class="num"><a href="#69">69</a></span><span class="full run">        <span class="k">if</span> <span class="n">eqi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span>            <span class="c1"># pump out a &#39;-&#39;, &#39;?&#39;, &#39;+&#39;, &#39;?&#39; quad for the synched lines</span></span>
<span class="num"><a href="#71">71</a></span><span class="full run">            <span class="n">atags</span> <span class="o">=</span> <span class="n">btags</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span></span>
<span class="num"><a href="#72">72</a></span><span class="full run">            <span class="n">cruncher</span><span class="o">.</span><span class="n">set_seqs</span><span class="p">(</span><span class="n">aelt</span><span class="p">,</span> <span class="n">belt</span><span class="p">)</span></span>
<span class="num"><a href="#73">73</a></span><span class="full run">            <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">ai1</span><span class="p">,</span> <span class="n">ai2</span><span class="p">,</span> <span class="n">bj1</span><span class="p">,</span> <span class="n">bj2</span> <span class="ow">in</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">get_opcodes</span><span class="p">():</span></span>
<span class="num"><a href="#74">74</a></span><span class="full run">                <span class="n">la</span><span class="p">,</span> <span class="n">lb</span> <span class="o">=</span> <span class="n">ai2</span> <span class="o">-</span> <span class="n">ai1</span><span class="p">,</span> <span class="n">bj2</span> <span class="o">-</span> <span class="n">bj1</span></span>
<span class="num"><a href="#75">75</a></span><span class="full run">                <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;replace&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#76">76</a></span><span class="full not_run">                    <span class="n">atags</span> <span class="o">+=</span> <span class="s1">&#39;^&#39;</span> <span class="o">*</span> <span class="n">la</span></span>
<span class="num"><a href="#77">77</a></span><span class="full not_run">                    <span class="n">btags</span> <span class="o">+=</span> <span class="s1">&#39;^&#39;</span> <span class="o">*</span> <span class="n">lb</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span class="full run">                    <span class="n">atags</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="n">la</span></span>
<span class="num"><a href="#80">80</a></span><span class="full run">                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;insert&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#81">81</a></span><span class="full run">                    <span class="n">btags</span> <span class="o">+=</span> <span class="s1">&#39;+&#39;</span> <span class="o">*</span> <span class="n">lb</span></span>
<span class="num"><a href="#82">82</a></span><span class="full run">                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;equal&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full run">                    <span class="n">atags</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">la</span></span>
<span class="num"><a href="#84">84</a></span><span class="full run">                    <span class="n">btags</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">lb</span></span>
<span class="num"><a href="#85">85</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unknown tag </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,))</span></span>
<span class="num"><a href="#87">87</a></span><span class="full run">            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qformat</span><span class="p">(</span><span class="n">aelt</span><span class="p">,</span> <span class="n">belt</span><span class="p">,</span> <span class="n">atags</span><span class="p">,</span> <span class="n">btags</span><span class="p">)</span></span>
<span class="num"><a href="#88">88</a></span><span>        <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span>            <span class="c1"># the synch pair is identical</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">yield</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">aelt</span></span>
<span class="num"><a href="#91">91</a></span><span></span>
<span class="num"><a href="#92">92</a></span><span>        <span class="c1"># pump out diffs from after the synch point</span></span>
<span class="num"><a href="#93">93</a></span><span class="full run">        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fancy_helper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">best_i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ahi</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">best_j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">bhi</span><span class="p">)</span></span>
            </pre>
            <p><b>Path 8</b>: 1 calls (0.01)</p>
                <p><button class="input"><span>&#8594;</span> a</button> ['', '   1. Beautiful is beTTer than ugly.', '   2. Explicit is better than &#305;mpl&#305;c&#305;t.', '   3. Simple is better than complex.', '   4. Complex is bett...</p>
                <p><button class="input"><span>&#8594;</span> alo</button> 1 (1) </p>
                <p><button class="input"><span>&#8594;</span> ahi</button> 5 (1) </p>
                <p><button class="input"><span>&#8594;</span> b</button> ['', '   1. Beautiful is better than &#252;gly.', '   3.   S&#305;mple is better than complex.', '   4. Complicated is better than c&#246;mplex.', '   5. Flat is bet...</p>
                <p><button class="input"><span>&#8594;</span> blo</button> 1 (1) </p>
                <p><button class="input"><span>&#8594;</span> bhi</button> 5 (1) </p>
                <p><button class="output"><span>&#8647; yield</span></button> '?                      ^^        ^\n' (2) '-    1. Beautiful is beTTer than ugly.' (1) '+    1. Beautiful is better than &#252;gly.' (1) '-    2. Explicit...</p>
            <button class="run" title="lines run...">34 run</button>
            <button class="not_run" title="lines not run...">10 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_fancy_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">alo</span><span class="p">,</span> <span class="n">ahi</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blo</span><span class="p">,</span> <span class="n">bhi</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span></span>
<span class="num"><a href="#3">3</a></span><span><span class="sd">        When replacing one block of lines with another, search the blocks</span></span>
<span class="num"><a href="#4">4</a></span><span><span class="sd">        for *similar* lines; the best-matching pair (if any) is used as a</span></span>
<span class="num"><a href="#5">5</a></span><span><span class="sd">        synch point, and intraline difference marking is done on the</span></span>
<span class="num"><a href="#6">6</a></span><span><span class="sd">        similar pair. Lots of work, but often worth it.</span></span>
<span class="num"><a href="#7">7</a></span><span></span>
<span class="num"><a href="#8">8</a></span><span><span class="sd">        Example:</span></span>
<span class="num"><a href="#9">9</a></span><span></span>
<span class="num"><a href="#10">10</a></span><span><span class="sd">        &gt;&gt;&gt; d = Differ()</span></span>
<span class="num"><a href="#11">11</a></span><span><span class="sd">        &gt;&gt;&gt; results = d._fancy_replace([&#39;abcDefghiJkl\n&#39;], 0, 1,</span></span>
<span class="num"><a href="#12">12</a></span><span><span class="sd">        ...                            [&#39;abcdefGhijkl\n&#39;], 0, 1)</span></span>
<span class="num"><a href="#13">13</a></span><span><span class="sd">        &gt;&gt;&gt; print(&#39;&#39;.join(results), end=&quot;&quot;)</span></span>
<span class="num"><a href="#14">14</a></span><span><span class="sd">        - abcDefghiJkl</span></span>
<span class="num"><a href="#15">15</a></span><span><span class="sd">        ?    ^  ^  ^</span></span>
<span class="num"><a href="#16">16</a></span><span><span class="sd">        + abcdefGhijkl</span></span>
<span class="num"><a href="#17">17</a></span><span><span class="sd">        ?    ^  ^  ^</span></span>
<span class="num"><a href="#18">18</a></span><span><span class="sd">        &quot;&quot;&quot;</span></span>
<span class="num"><a href="#19">19</a></span><span></span>
<span class="num"><a href="#20">20</a></span><span>        <span class="c1"># don&#39;t synch up unless the lines have a similarity score of at</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># least cutoff; best_ratio tracks the best score seen so far</span></span>
<span class="num"><a href="#22">22</a></span><span class="full run">        <span class="n">best_ratio</span><span class="p">,</span> <span class="n">cutoff</span> <span class="o">=</span> <span class="mf">0.74</span><span class="p">,</span> <span class="mf">0.75</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="n">cruncher</span> <span class="o">=</span> <span class="n">SequenceMatcher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charjunk</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span class="full run">        <span class="n">eqi</span><span class="p">,</span> <span class="n">eqj</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>   <span class="c1"># 1st indices of equal lines (if any)</span></span>
<span class="num"><a href="#25">25</a></span><span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># search for the pair that matches best without being identical</span></span>
<span class="num"><a href="#27">27</a></span><span>        <span class="c1"># (identical lines must be junk lines, &amp; we don&#39;t want to synch up</span></span>
<span class="num"><a href="#28">28</a></span><span>        <span class="c1"># on junk -- unless we have to)</span></span>
<span class="num"><a href="#29">29</a></span><span class="full run">        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">blo</span><span class="p">,</span> <span class="n">bhi</span><span class="p">):</span></span>
<span class="num"><a href="#30">30</a></span><span class="full run">            <span class="n">bj</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">]</span></span>
<span class="num"><a href="#31">31</a></span><span class="full run">            <span class="n">cruncher</span><span class="o">.</span><span class="n">set_seq2</span><span class="p">(</span><span class="n">bj</span><span class="p">)</span></span>
<span class="num"><a href="#32">32</a></span><span class="full run">            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">alo</span><span class="p">,</span> <span class="n">ahi</span><span class="p">):</span></span>
<span class="num"><a href="#33">33</a></span><span class="full run">                <span class="n">ai</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></span>
<span class="num"><a href="#34">34</a></span><span class="full run">                <span class="k">if</span> <span class="n">ai</span> <span class="o">==</span> <span class="n">bj</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">eqi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                        <span class="n">eqi</span><span class="p">,</span> <span class="n">eqj</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#38">38</a></span><span class="full run">                <span class="n">cruncher</span><span class="o">.</span><span class="n">set_seq1</span><span class="p">(</span><span class="n">ai</span><span class="p">)</span></span>
<span class="num"><a href="#39">39</a></span><span>                <span class="c1"># computing similarity is expensive, so use the quick</span></span>
<span class="num"><a href="#40">40</a></span><span>                <span class="c1"># upper bounds first -- have seen this speed up messy</span></span>
<span class="num"><a href="#41">41</a></span><span>                <span class="c1"># compares by a factor of 3.</span></span>
<span class="num"><a href="#42">42</a></span><span>                <span class="c1"># note that ratio() is only expensive to compute the first</span></span>
<span class="num"><a href="#43">43</a></span><span>                <span class="c1"># time it&#39;s called on a sequence pair; the expensive part</span></span>
<span class="num"><a href="#44">44</a></span><span>                <span class="c1"># of the computation is cached by cruncher</span></span>
<span class="num"><a href="#45">45</a></span><span class="full run">                <span class="k">if</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">real_quick_ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">best_ratio</span> <span class="ow">and</span> \</span>
<span class="num"><a href="#46">46</a></span><span class="full run">                      <span class="n">cruncher</span><span class="o">.</span><span class="n">quick_ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">best_ratio</span> <span class="ow">and</span> \</span>
<span class="num"><a href="#47">47</a></span><span class="full run">                      <span class="n">cruncher</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">best_ratio</span><span class="p">:</span></span>
<span class="num"><a href="#48">48</a></span><span class="full run">                    <span class="n">best_ratio</span><span class="p">,</span> <span class="n">best_i</span><span class="p">,</span> <span class="n">best_j</span> <span class="o">=</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">ratio</span><span class="p">(),</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span></span>
<span class="num"><a href="#49">49</a></span><span class="full run">        <span class="k">if</span> <span class="n">best_ratio</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">:</span></span>
<span class="num"><a href="#50">50</a></span><span>            <span class="c1"># no non-identical &quot;pretty close&quot; pair</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">eqi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#52">52</a></span><span>                <span class="c1"># no identical pair either -- treat it as a straight replace</span></span>
<span class="num"><a href="#53">53</a></span><span class="full not_run">                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plain_replace</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">alo</span><span class="p">,</span> <span class="n">ahi</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blo</span><span class="p">,</span> <span class="n">bhi</span><span class="p">)</span></span>
<span class="num"><a href="#54">54</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#55">55</a></span><span>            <span class="c1"># no close pair, but an identical pair -- synch up on that</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">            <span class="n">best_i</span><span class="p">,</span> <span class="n">best_j</span><span class="p">,</span> <span class="n">best_ratio</span> <span class="o">=</span> <span class="n">eqi</span><span class="p">,</span> <span class="n">eqj</span><span class="p">,</span> <span class="mf">1.0</span></span>
<span class="num"><a href="#57">57</a></span><span>        <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#58">58</a></span><span>            <span class="c1"># there&#39;s a close pair, so forget the identical pair (if any)</span></span>
<span class="num"><a href="#59">59</a></span><span class="full run">            <span class="n">eqi</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#60">60</a></span><span></span>
<span class="num"><a href="#61">61</a></span><span>        <span class="c1"># a[best_i] very similar to b[best_j]; eqi is None iff they&#39;re not</span></span>
<span class="num"><a href="#62">62</a></span><span>        <span class="c1"># identical</span></span>
<span class="num"><a href="#63">63</a></span><span></span>
<span class="num"><a href="#64">64</a></span><span>        <span class="c1"># pump out diffs from before the synch point</span></span>
<span class="num"><a href="#65">65</a></span><span class="full run">        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fancy_helper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">alo</span><span class="p">,</span> <span class="n">best_i</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blo</span><span class="p">,</span> <span class="n">best_j</span><span class="p">)</span></span>
<span class="num"><a href="#66">66</a></span><span></span>
<span class="num"><a href="#67">67</a></span><span>        <span class="c1"># do intraline marking on the synch pair</span></span>
<span class="num"><a href="#68">68</a></span><span class="full run">        <span class="n">aelt</span><span class="p">,</span> <span class="n">belt</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">best_i</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">best_j</span><span class="p">]</span></span>
<span class="num"><a href="#69">69</a></span><span class="full run">        <span class="k">if</span> <span class="n">eqi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span>            <span class="c1"># pump out a &#39;-&#39;, &#39;?&#39;, &#39;+&#39;, &#39;?&#39; quad for the synched lines</span></span>
<span class="num"><a href="#71">71</a></span><span class="full run">            <span class="n">atags</span> <span class="o">=</span> <span class="n">btags</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span></span>
<span class="num"><a href="#72">72</a></span><span class="full run">            <span class="n">cruncher</span><span class="o">.</span><span class="n">set_seqs</span><span class="p">(</span><span class="n">aelt</span><span class="p">,</span> <span class="n">belt</span><span class="p">)</span></span>
<span class="num"><a href="#73">73</a></span><span class="full run">            <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">ai1</span><span class="p">,</span> <span class="n">ai2</span><span class="p">,</span> <span class="n">bj1</span><span class="p">,</span> <span class="n">bj2</span> <span class="ow">in</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">get_opcodes</span><span class="p">():</span></span>
<span class="num"><a href="#74">74</a></span><span class="full run">                <span class="n">la</span><span class="p">,</span> <span class="n">lb</span> <span class="o">=</span> <span class="n">ai2</span> <span class="o">-</span> <span class="n">ai1</span><span class="p">,</span> <span class="n">bj2</span> <span class="o">-</span> <span class="n">bj1</span></span>
<span class="num"><a href="#75">75</a></span><span class="full run">                <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;replace&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#76">76</a></span><span class="full run">                    <span class="n">atags</span> <span class="o">+=</span> <span class="s1">&#39;^&#39;</span> <span class="o">*</span> <span class="n">la</span></span>
<span class="num"><a href="#77">77</a></span><span class="full run">                    <span class="n">btags</span> <span class="o">+=</span> <span class="s1">&#39;^&#39;</span> <span class="o">*</span> <span class="n">lb</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span class="full not_run">                    <span class="n">atags</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="n">la</span></span>
<span class="num"><a href="#80">80</a></span><span class="full run">                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;insert&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#81">81</a></span><span class="full run">                    <span class="n">btags</span> <span class="o">+=</span> <span class="s1">&#39;+&#39;</span> <span class="o">*</span> <span class="n">lb</span></span>
<span class="num"><a href="#82">82</a></span><span class="full run">                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;equal&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full run">                    <span class="n">atags</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">la</span></span>
<span class="num"><a href="#84">84</a></span><span class="full run">                    <span class="n">btags</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">lb</span></span>
<span class="num"><a href="#85">85</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unknown tag </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,))</span></span>
<span class="num"><a href="#87">87</a></span><span class="full run">            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qformat</span><span class="p">(</span><span class="n">aelt</span><span class="p">,</span> <span class="n">belt</span><span class="p">,</span> <span class="n">atags</span><span class="p">,</span> <span class="n">btags</span><span class="p">)</span></span>
<span class="num"><a href="#88">88</a></span><span>        <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span>            <span class="c1"># the synch pair is identical</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">yield</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">aelt</span></span>
<span class="num"><a href="#91">91</a></span><span></span>
<span class="num"><a href="#92">92</a></span><span>        <span class="c1"># pump out diffs from after the synch point</span></span>
<span class="num"><a href="#93">93</a></span><span class="full run">        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fancy_helper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">best_i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ahi</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">best_j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">bhi</span><span class="p">)</span></span>
            </pre>
            <p><b>Path 9</b>: 1 calls (0.01)</p>
                <p><button class="input"><span>&#8594;</span> a</button> ['  1. Beautiful is better than ugly.\n', '  2. Explicit is better than implicit.\n', '  3. Simple is better than complex.\n', '  4. Complex is better...</p>
                <p><button class="input"><span>&#8594;</span> alo</button> 3 (1) </p>
                <p><button class="input"><span>&#8594;</span> ahi</button> 4 (1) </p>
                <p><button class="input"><span>&#8594;</span> b</button> ['  1. Beautiful is better than ugly.\n', '  3.   Simple is better than complex.\n', '  4. Complicated is better than complex.\n', '  5. Flat is bette...</p>
                <p><button class="input"><span>&#8594;</span> blo</button> 2 (1) </p>
                <p><button class="input"><span>&#8594;</span> bhi</button> 4 (1) </p>
                <p><button class="output"><span>&#8647; yield</span></button> '-   4. Complex is better than complicated.\n' (1) '?            ^                     ---- ^\n' (1) '+   4. Complicated is better than complex.\n' (1...</p>
            <button class="run" title="lines run...">35 run</button>
            <button class="not_run" title="lines not run...">9 not run</button>
            <pre>
<span class="num"><a href="#1">1</a></span><span><span class="k">def</span> <span class="nf">_fancy_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">alo</span><span class="p">,</span> <span class="n">ahi</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blo</span><span class="p">,</span> <span class="n">bhi</span><span class="p">):</span></span>
<span class="num"><a href="#2">2</a></span><span><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span></span>
<span class="num"><a href="#3">3</a></span><span><span class="sd">        When replacing one block of lines with another, search the blocks</span></span>
<span class="num"><a href="#4">4</a></span><span><span class="sd">        for *similar* lines; the best-matching pair (if any) is used as a</span></span>
<span class="num"><a href="#5">5</a></span><span><span class="sd">        synch point, and intraline difference marking is done on the</span></span>
<span class="num"><a href="#6">6</a></span><span><span class="sd">        similar pair. Lots of work, but often worth it.</span></span>
<span class="num"><a href="#7">7</a></span><span></span>
<span class="num"><a href="#8">8</a></span><span><span class="sd">        Example:</span></span>
<span class="num"><a href="#9">9</a></span><span></span>
<span class="num"><a href="#10">10</a></span><span><span class="sd">        &gt;&gt;&gt; d = Differ()</span></span>
<span class="num"><a href="#11">11</a></span><span><span class="sd">        &gt;&gt;&gt; results = d._fancy_replace([&#39;abcDefghiJkl\n&#39;], 0, 1,</span></span>
<span class="num"><a href="#12">12</a></span><span><span class="sd">        ...                            [&#39;abcdefGhijkl\n&#39;], 0, 1)</span></span>
<span class="num"><a href="#13">13</a></span><span><span class="sd">        &gt;&gt;&gt; print(&#39;&#39;.join(results), end=&quot;&quot;)</span></span>
<span class="num"><a href="#14">14</a></span><span><span class="sd">        - abcDefghiJkl</span></span>
<span class="num"><a href="#15">15</a></span><span><span class="sd">        ?    ^  ^  ^</span></span>
<span class="num"><a href="#16">16</a></span><span><span class="sd">        + abcdefGhijkl</span></span>
<span class="num"><a href="#17">17</a></span><span><span class="sd">        ?    ^  ^  ^</span></span>
<span class="num"><a href="#18">18</a></span><span><span class="sd">        &quot;&quot;&quot;</span></span>
<span class="num"><a href="#19">19</a></span><span></span>
<span class="num"><a href="#20">20</a></span><span>        <span class="c1"># don&#39;t synch up unless the lines have a similarity score of at</span></span>
<span class="num"><a href="#21">21</a></span><span>        <span class="c1"># least cutoff; best_ratio tracks the best score seen so far</span></span>
<span class="num"><a href="#22">22</a></span><span class="full run">        <span class="n">best_ratio</span><span class="p">,</span> <span class="n">cutoff</span> <span class="o">=</span> <span class="mf">0.74</span><span class="p">,</span> <span class="mf">0.75</span></span>
<span class="num"><a href="#23">23</a></span><span class="full run">        <span class="n">cruncher</span> <span class="o">=</span> <span class="n">SequenceMatcher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charjunk</span><span class="p">)</span></span>
<span class="num"><a href="#24">24</a></span><span class="full run">        <span class="n">eqi</span><span class="p">,</span> <span class="n">eqj</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>   <span class="c1"># 1st indices of equal lines (if any)</span></span>
<span class="num"><a href="#25">25</a></span><span></span>
<span class="num"><a href="#26">26</a></span><span>        <span class="c1"># search for the pair that matches best without being identical</span></span>
<span class="num"><a href="#27">27</a></span><span>        <span class="c1"># (identical lines must be junk lines, &amp; we don&#39;t want to synch up</span></span>
<span class="num"><a href="#28">28</a></span><span>        <span class="c1"># on junk -- unless we have to)</span></span>
<span class="num"><a href="#29">29</a></span><span class="full run">        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">blo</span><span class="p">,</span> <span class="n">bhi</span><span class="p">):</span></span>
<span class="num"><a href="#30">30</a></span><span class="full run">            <span class="n">bj</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">]</span></span>
<span class="num"><a href="#31">31</a></span><span class="full run">            <span class="n">cruncher</span><span class="o">.</span><span class="n">set_seq2</span><span class="p">(</span><span class="n">bj</span><span class="p">)</span></span>
<span class="num"><a href="#32">32</a></span><span class="full run">            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">alo</span><span class="p">,</span> <span class="n">ahi</span><span class="p">):</span></span>
<span class="num"><a href="#33">33</a></span><span class="full run">                <span class="n">ai</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></span>
<span class="num"><a href="#34">34</a></span><span class="full run">                <span class="k">if</span> <span class="n">ai</span> <span class="o">==</span> <span class="n">bj</span><span class="p">:</span></span>
<span class="num"><a href="#35">35</a></span><span class="full not_run">                    <span class="k">if</span> <span class="n">eqi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#36">36</a></span><span class="full not_run">                        <span class="n">eqi</span><span class="p">,</span> <span class="n">eqj</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span></span>
<span class="num"><a href="#37">37</a></span><span class="full not_run">                    <span class="k">continue</span></span>
<span class="num"><a href="#38">38</a></span><span class="full run">                <span class="n">cruncher</span><span class="o">.</span><span class="n">set_seq1</span><span class="p">(</span><span class="n">ai</span><span class="p">)</span></span>
<span class="num"><a href="#39">39</a></span><span>                <span class="c1"># computing similarity is expensive, so use the quick</span></span>
<span class="num"><a href="#40">40</a></span><span>                <span class="c1"># upper bounds first -- have seen this speed up messy</span></span>
<span class="num"><a href="#41">41</a></span><span>                <span class="c1"># compares by a factor of 3.</span></span>
<span class="num"><a href="#42">42</a></span><span>                <span class="c1"># note that ratio() is only expensive to compute the first</span></span>
<span class="num"><a href="#43">43</a></span><span>                <span class="c1"># time it&#39;s called on a sequence pair; the expensive part</span></span>
<span class="num"><a href="#44">44</a></span><span>                <span class="c1"># of the computation is cached by cruncher</span></span>
<span class="num"><a href="#45">45</a></span><span class="full run">                <span class="k">if</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">real_quick_ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">best_ratio</span> <span class="ow">and</span> \</span>
<span class="num"><a href="#46">46</a></span><span class="full run">                      <span class="n">cruncher</span><span class="o">.</span><span class="n">quick_ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">best_ratio</span> <span class="ow">and</span> \</span>
<span class="num"><a href="#47">47</a></span><span class="full run">                      <span class="n">cruncher</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">best_ratio</span><span class="p">:</span></span>
<span class="num"><a href="#48">48</a></span><span class="full run">                    <span class="n">best_ratio</span><span class="p">,</span> <span class="n">best_i</span><span class="p">,</span> <span class="n">best_j</span> <span class="o">=</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">ratio</span><span class="p">(),</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span></span>
<span class="num"><a href="#49">49</a></span><span class="full run">        <span class="k">if</span> <span class="n">best_ratio</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">:</span></span>
<span class="num"><a href="#50">50</a></span><span>            <span class="c1"># no non-identical &quot;pretty close&quot; pair</span></span>
<span class="num"><a href="#51">51</a></span><span class="full not_run">            <span class="k">if</span> <span class="n">eqi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#52">52</a></span><span>                <span class="c1"># no identical pair either -- treat it as a straight replace</span></span>
<span class="num"><a href="#53">53</a></span><span class="full not_run">                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plain_replace</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">alo</span><span class="p">,</span> <span class="n">ahi</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blo</span><span class="p">,</span> <span class="n">bhi</span><span class="p">)</span></span>
<span class="num"><a href="#54">54</a></span><span class="full not_run">                <span class="k">return</span></span>
<span class="num"><a href="#55">55</a></span><span>            <span class="c1"># no close pair, but an identical pair -- synch up on that</span></span>
<span class="num"><a href="#56">56</a></span><span class="full not_run">            <span class="n">best_i</span><span class="p">,</span> <span class="n">best_j</span><span class="p">,</span> <span class="n">best_ratio</span> <span class="o">=</span> <span class="n">eqi</span><span class="p">,</span> <span class="n">eqj</span><span class="p">,</span> <span class="mf">1.0</span></span>
<span class="num"><a href="#57">57</a></span><span>        <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#58">58</a></span><span>            <span class="c1"># there&#39;s a close pair, so forget the identical pair (if any)</span></span>
<span class="num"><a href="#59">59</a></span><span class="full run">            <span class="n">eqi</span> <span class="o">=</span> <span class="kc">None</span></span>
<span class="num"><a href="#60">60</a></span><span></span>
<span class="num"><a href="#61">61</a></span><span>        <span class="c1"># a[best_i] very similar to b[best_j]; eqi is None iff they&#39;re not</span></span>
<span class="num"><a href="#62">62</a></span><span>        <span class="c1"># identical</span></span>
<span class="num"><a href="#63">63</a></span><span></span>
<span class="num"><a href="#64">64</a></span><span>        <span class="c1"># pump out diffs from before the synch point</span></span>
<span class="num"><a href="#65">65</a></span><span class="full run">        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fancy_helper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">alo</span><span class="p">,</span> <span class="n">best_i</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blo</span><span class="p">,</span> <span class="n">best_j</span><span class="p">)</span></span>
<span class="num"><a href="#66">66</a></span><span></span>
<span class="num"><a href="#67">67</a></span><span>        <span class="c1"># do intraline marking on the synch pair</span></span>
<span class="num"><a href="#68">68</a></span><span class="full run">        <span class="n">aelt</span><span class="p">,</span> <span class="n">belt</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">best_i</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">best_j</span><span class="p">]</span></span>
<span class="num"><a href="#69">69</a></span><span class="full run">        <span class="k">if</span> <span class="n">eqi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></span>
<span class="num"><a href="#70">70</a></span><span>            <span class="c1"># pump out a &#39;-&#39;, &#39;?&#39;, &#39;+&#39;, &#39;?&#39; quad for the synched lines</span></span>
<span class="num"><a href="#71">71</a></span><span class="full run">            <span class="n">atags</span> <span class="o">=</span> <span class="n">btags</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span></span>
<span class="num"><a href="#72">72</a></span><span class="full run">            <span class="n">cruncher</span><span class="o">.</span><span class="n">set_seqs</span><span class="p">(</span><span class="n">aelt</span><span class="p">,</span> <span class="n">belt</span><span class="p">)</span></span>
<span class="num"><a href="#73">73</a></span><span class="full run">            <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">ai1</span><span class="p">,</span> <span class="n">ai2</span><span class="p">,</span> <span class="n">bj1</span><span class="p">,</span> <span class="n">bj2</span> <span class="ow">in</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">get_opcodes</span><span class="p">():</span></span>
<span class="num"><a href="#74">74</a></span><span class="full run">                <span class="n">la</span><span class="p">,</span> <span class="n">lb</span> <span class="o">=</span> <span class="n">ai2</span> <span class="o">-</span> <span class="n">ai1</span><span class="p">,</span> <span class="n">bj2</span> <span class="o">-</span> <span class="n">bj1</span></span>
<span class="num"><a href="#75">75</a></span><span class="full run">                <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;replace&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#76">76</a></span><span class="full run">                    <span class="n">atags</span> <span class="o">+=</span> <span class="s1">&#39;^&#39;</span> <span class="o">*</span> <span class="n">la</span></span>
<span class="num"><a href="#77">77</a></span><span class="full run">                    <span class="n">btags</span> <span class="o">+=</span> <span class="s1">&#39;^&#39;</span> <span class="o">*</span> <span class="n">lb</span></span>
<span class="num"><a href="#78">78</a></span><span class="full run">                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#79">79</a></span><span class="full run">                    <span class="n">atags</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="n">la</span></span>
<span class="num"><a href="#80">80</a></span><span class="full run">                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;insert&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#81">81</a></span><span class="full run">                    <span class="n">btags</span> <span class="o">+=</span> <span class="s1">&#39;+&#39;</span> <span class="o">*</span> <span class="n">lb</span></span>
<span class="num"><a href="#82">82</a></span><span class="full run">                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;equal&#39;</span><span class="p">:</span></span>
<span class="num"><a href="#83">83</a></span><span class="full run">                    <span class="n">atags</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">la</span></span>
<span class="num"><a href="#84">84</a></span><span class="full run">                    <span class="n">btags</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">lb</span></span>
<span class="num"><a href="#85">85</a></span><span>                <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#86">86</a></span><span class="full not_run">                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unknown tag </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,))</span></span>
<span class="num"><a href="#87">87</a></span><span class="full run">            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qformat</span><span class="p">(</span><span class="n">aelt</span><span class="p">,</span> <span class="n">belt</span><span class="p">,</span> <span class="n">atags</span><span class="p">,</span> <span class="n">btags</span><span class="p">)</span></span>
<span class="num"><a href="#88">88</a></span><span>        <span class="k">else</span><span class="p">:</span></span>
<span class="num"><a href="#89">89</a></span><span>            <span class="c1"># the synch pair is identical</span></span>
<span class="num"><a href="#90">90</a></span><span class="full not_run">            <span class="k">yield</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">aelt</span></span>
<span class="num"><a href="#91">91</a></span><span></span>
<span class="num"><a href="#92">92</a></span><span>        <span class="c1"># pump out diffs from after the synch point</span></span>
<span class="num"><a href="#93">93</a></span><span class="full run">        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fancy_helper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">best_i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ahi</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">best_j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">bhi</span><span class="p">)</span></span>
            </pre>
    </div>
</div>
<i class="bi bi-arrow-down"></i>
</body>
</html>
